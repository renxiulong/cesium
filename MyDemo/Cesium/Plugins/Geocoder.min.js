"use strict";var startSearchPath="M29.772,26.433l-7.126-7.126c0.96-1.583,1.523-3.435,1.524-5.421C24.169,8.093,19.478,3.401,13.688,3.399C7.897,3.401,3.204,8.093,3.204,13.885c0,5.789,4.693,10.481,10.484,10.481c1.987,0,3.839-0.563,5.422-1.523l7.128,7.127L29.772,26.433zM7.203,13.885c0.006-3.582,2.903-6.478,6.484-6.486c3.579,0.008,6.478,2.904,6.484,6.486c-0.007,3.58-2.905,6.476-6.484,6.484C10.106,20.361,7.209,17.465,7.203,13.885z",stopSearchPath="M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z";function Geocoders(e){if(!Cesium.defined(e)||!Cesium.defined(e.container))throw new Cesium.DeveloperError("options.container is required.");if(!Cesium.defined(e.scene))throw new Cesium.DeveloperError("options.scene is required.");var t=Cesium.getElement(e.container),n=new GeocoderViewModel(e);n._startSearchPath=startSearchPath,n._stopSearchPath=stopSearchPath;var i=document.createElement("form");i.setAttribute("data-bind","submit: search");var s=document.createElement("input");s.type="search",s.className="cesium-geocoder-input",s.setAttribute("placeholder","输入搜索地址..."),s.setAttribute("data-bind",'textInput: searchText,disable: isSearchInProgress,event: { keyup: handleKeyUp, keydown: handleKeyDown, mouseover: deselectSuggestion },css: { "cesium-geocoder-input-wide" : keepExpanded || searchText.length > 0 },hasFocus: _focusTextbox'),s.setAttribute("style","top:28px"),this._onTextBoxFocus=function(){setTimeout(function(){s.select()},0)},i.appendChild(s),this._textBox=s;var o=document.createElement("span");o.className="cesium-geocoder-searchButton",o.setAttribute("data-bind","click: search,cesiumSvgPath: { path: isSearchInProgress ? _stopSearchPath : _startSearchPath, width: 32, height: 32 }"),i.appendChild(o),t.appendChild(i);var r=document.createElement("div");r.className="search-results",r.setAttribute("data-bind","visible: _suggestionsVisible");var a=document.createElement("ul");a.setAttribute("data-bind","foreach: _suggestions");var c=document.createElement("li");a.appendChild(c),c.setAttribute("data-bind","text: $data.displayName, click: $parent.activateSuggestion, event: { mouseover: $parent.handleMouseover}, css: { active: $data === $parent._selectedSuggestion }"),r.appendChild(a),t.appendChild(r),Cesium.knockout.applyBindings(n,i),Cesium.knockout.applyBindings(n,r),this._container=t,this._searchSuggestionsContainer=r,this._viewModel=n,this._form=i,this._onInputBegin=function(e){t.contains(e.target)||(n._focusTextbox=!1,n.hideSuggestions())},this._onInputEnd=function(e){t.contains(e.target)&&(n._focusTextbox=!0,n.showSuggestions())},Cesium.FeatureDetection.supportsPointerEvents()?(document.addEventListener("pointerdown",this._onInputBegin,!0),document.addEventListener("pointerup",this._onInputEnd,!0),document.addEventListener("pointercancel",this._onInputEnd,!0)):(document.addEventListener("mousedown",this._onInputBegin,!0),document.addEventListener("mouseup",this._onInputEnd,!0),document.addEventListener("touchstart",this._onInputBegin,!0),document.addEventListener("touchend",this._onInputEnd,!0),document.addEventListener("touchcancel",this._onInputEnd,!0))}function mapServicesGeocoder(e){this.scene=e}function GeocoderViewModel(e){if(!Cesium.defined(e)||!Cesium.defined(e.scene))throw new Cesium.DeveloperError("options.scene is required.");e.geocoderServices=[],e.geocoderServices.push(new mapServicesGeocoder(e.scene)),Cesium.defined(e.geocoderServices)?this._geocoderServices=e.geocoderServices:this._geocoderServices=[new Cesium.CartographicGeocoderService,new Cesium.IonGeocoderService({scene:e.scene})],this._viewContainer=e.container,this._locationBillboard=void 0,this._locationLabel=void 0,this._scene=e.scene,this._viewer=e.viewer,this._flightDuration=e.flightDuration,this._searchText="",this._isSearchInProgress=!1,this._geocodePromise=void 0,this._complete=new Cesium.Event,this._suggestions=[],this._selectedSuggestion=void 0,this._showSuggestions=!0,this._updateCamera=updateCamera,this._adjustSuggestionsScroll=adjustSuggestionsScroll,this._updateSearchSuggestions=updateSearchSuggestions,this._handleArrowDown=handleArrowDown,this._handleArrowUp=handleArrowUp;var o=this;this._suggestionsVisible=Cesium.knockout.pureComputed(function(){var e=0<Cesium.knockout.getObservable(o,"_suggestions")().length,t=Cesium.knockout.getObservable(o,"_showSuggestions")();return e&&t}),this._searchCommand=Cesium.createCommand(function(e){if(e=Cesium.defaultValue(e,Cesium.GeocodeType.SEARCH),o._focusTextbox=!1,Cesium.defined(o._selectedSuggestion))return o.activateSuggestion(o._selectedSuggestion),!1;o.hideSuggestions(),o.isSearchInProgress?cancelGeocode(o):geocode(o,o._geocoderServices,e)}),this.deselectSuggestion=function(){o._selectedSuggestion=void 0},this.handleKeyDown=function(e,t){var n="ArrowDown"===t.key||"Down"===t.key||40===t.keyCode,i="ArrowUp"===t.key||"Up"===t.key||38===t.keyCode;return(n||i)&&t.preventDefault(),!0},this.handleKeyUp=function(e,t){var n="ArrowDown"===t.key||"Down"===t.key||40===t.keyCode,i="ArrowUp"===t.key||"Up"===t.key||38===t.keyCode,s="Enter"===t.key||13===t.keyCode;return i?handleArrowUp(o):n?handleArrowDown(o):s&&o._searchCommand(),!0},this.activateSuggestion=function(e){o.hideSuggestions(),o._searchText=e.displayName;var t=e.destination;clearSuggestions(o),updateCamera(o,t)},this.hideSuggestions=function(){o._showSuggestions=!1,o._selectedSuggestion=void 0,document.querySelector(".cesium-geocoder-input").offsetWidth<100&&(Cesium.defined(o._locationBillboard)&&(o._locationBillboard.show=!1),Cesium.defined(o._locationLabel)&&(o._locationLabel.show=!1))},this.showSuggestions=function(){o._showSuggestions=!0},this.handleMouseover=function(e,t){e!==o._selectedSuggestion&&(o._selectedSuggestion=e)},this.keepExpanded=!1,this.autoComplete=Cesium.defaultValue(e.autocomplete,!0),this._focusTextbox=!1,Cesium.knockout.track(this,["_searchText","_isSearchInProgress","keepExpanded","_suggestions","_selectedSuggestion","_showSuggestions","_focusTextbox"]);var t=Cesium.knockout.getObservable(this,"_searchText");t.extend({rateLimit:{timeout:500}}),this._suggestionSubscription=t.subscribe(function(){updateSearchSuggestions(o)}),this.isSearchInProgress=void 0,Cesium.knockout.defineProperty(this,"isSearchInProgress",{get:function(){return this._isSearchInProgress}}),this.searchText=void 0,Cesium.knockout.defineProperty(this,"searchText",{get:function(){return this.isSearchInProgress?"Searching...":this._searchText},set:function(e){if("string"!=typeof e)throw new Cesium.DeveloperError("value must be a valid string.");this._searchText=e}}),this.flightDuration=void 0,Cesium.knockout.defineProperty(this,"flightDuration",{get:function(){return this._flightDuration},set:function(e){if(Cesium.defined(e)&&e<0)throw new Cesium.DeveloperError("value must be positive.");this._flightDuration=e}})}function handleArrowUp(e){if(0!==e._suggestions.length){var t,n=e._suggestions.indexOf(e._selectedSuggestion);-1!==n&&0!==n?(t=n-1,e._selectedSuggestion=e._suggestions[t],adjustSuggestionsScroll(e,t)):e._selectedSuggestion=void 0}}function handleArrowDown(e){if(0!==e._suggestions.length){var t=e._suggestions.length,n=(e._suggestions.indexOf(e._selectedSuggestion)+1)%t;e._selectedSuggestion=e._suggestions[n],adjustSuggestionsScroll(e,n)}}function updateCamera(e,t){var n=e._viewer.scene.globe.ellipsoid.cartesianToCartographic(t),i=Cesium.Math.toDegrees(n.longitude),s=Cesium.Math.toDegrees(n.latitude),o=n.height-1e3;Cesium.defined(e._locationBillboard)?(e._locationBillboard.show=!0,e._locationBillboard.position=Cesium.Cartesian3.fromDegrees(i,s,o)):e._locationBillboard=e._viewer.entities.add({position:Cesium.Cartesian3.fromDegrees(i,s,o),billboard:{image:"".concat(e._viewer._basePath,"/Plugins/assets/geolocation.png"),verticalOrigin:Cesium.VerticalOrigin.BOTTOM,show:!0,width:40,height:50,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}}),Cesium.defined(e._locationLabel)?(e._locationLabel.show=!0,e._locationLabel.position=Cesium.Cartesian3.fromDegrees(i,s,o),e._locationLabel.label.text=e._searchText):e._locationLabel=e._viewer.entities.add({position:Cesium.Cartesian3.fromDegrees(i,s,o),label:{text:e._searchText,pixelOffset:new Cesium.Cartesian2(0,-70),scale:.8}}),e._scene.camera.flyTo({destination:t,complete:function(){e._complete.raiseEvent()},duration:e._flightDuration,endTransform:Cesium.Matrix4.IDENTITY})}function chainPromise(e,t,n,i){return e.then(function(e){return Cesium.defined(e)&&"fulfilled"===e.state&&0<e.value.length?e:t.geocode(n,i).then(function(e){return{state:"fulfilled",value:e}}).otherwise(function(e){return{state:"rejected",reason:e}})})}function geocode(n,e,t){var i=n._searchText;if(hasOnlyWhitespace(i))n.showSuggestions();else{n._isSearchInProgress=!0;for(var s=Cesium.when.resolve(),o=0;o<e.length;o++)s=chainPromise(s,e[o],i,t);(n._geocodePromise=s).then(function(e){if(!s.cancel){n._isSearchInProgress=!1;var t=e.value;if("fulfilled"===e.state&&Cesium.defined(t)&&0<t.length)return n._searchText=t[0].displayName,void updateCamera(n,t[0].destination);n._searchText=i+" (not found)"}})}}function adjustSuggestionsScroll(e,t){var n=Cesium.getElement(e._viewContainer),i=n.getElementsByClassName("search-results")[0],s=n.getElementsByTagName("li")[t];if(0!==t){var o=s.offsetTop;o+s.clientHeight>i.clientHeight?i.scrollTop=o+s.clientHeight:o<i.scrollTop&&(i.scrollTop=o)}else i.scrollTop=0}function cancelGeocode(e){e._isSearchInProgress=!1,Cesium.defined(e._geocodePromise)&&(e._geocodePromise.cancel=!0,e._geocodePromise=void 0)}function hasOnlyWhitespace(e){return/^\s*$/.test(e)}function clearSuggestions(e){Cesium.knockout.getObservable(e,"_suggestions").removeAll()}function updateSearchSuggestions(i){if(i.autoComplete){var n=i._searchText;if(clearSuggestions(i),!hasOnlyWhitespace(n)){var t=Cesium.when.resolve([]);i._geocoderServices.forEach(function(e){t=t.then(function(t){return 5<=t.length?t:e.geocode(n,Cesium.GeocodeType.AUTOCOMPLETE).then(function(e){return t=t.concat(e)})})}),t.then(function(e){for(var t=i._suggestions,n=0;n<e.length;n++)t.push(e[n])})}}}Cesium.defineProperties(Geocoders.prototype,{container:{get:function(){return this._container}},searchSuggestionsContainer:{get:function(){return this._searchSuggestionsContainer}},viewModel:{get:function(){return this._viewModel}}}),Geocoders.prototype.isDestroyed=function(){return!1},Geocoders.prototype.destroy=function(){return Cesium.FeatureDetection.supportsPointerEvents()?(document.removeEventListener("pointerdown",this._onInputBegin,!0),document.removeEventListener("pointerup",this._onInputEnd,!0)):(document.removeEventListener("mousedown",this._onInputBegin,!0),document.removeEventListener("mouseup",this._onInputEnd,!0),document.removeEventListener("touchstart",this._onInputBegin,!0),document.removeEventListener("touchend",this._onInputEnd,!0)),this._viewModel.destroy(),Cesium.knockout.cleanNode(this._form),Cesium.knockout.cleanNode(this._searchSuggestionsContainer),this._container.removeChild(this._form),this._container.removeChild(this._searchSuggestionsContainer),this._textBox.removeEventListener("focus",this._onTextBoxFocus,!1),Cesium.destroyObject(this)},mapServicesGeocoder.prototype.geocode=function(e){var a=this;return new Cesium.Resource({url:"https://restapi.amap.com/v3/place/text",queryParameters:{key:"7ddb52a724411aa175124f2a3f1526b6",keywords:e,offset:10,format:"json",q:e}}).fetchJson().then(function(e){var n,i,s,o,r;return e.pois.map(function(e){n=e.location,i=n.split(","),s=parseFloat(i[0]),o=parseFloat(i[1]),(r=a.scene.globe.getHeight(Cesium.Cartographic.fromDegrees(s,o)))<0&&(r=0);var t=GCJ02WGS84(s,o);return{displayName:e.cityname+e.adname+e.name,destination:Cesium.Cartesian3.fromDegrees(t[0],t[1],r+1e3)}})})},Cesium.defineProperties(GeocoderViewModel.prototype,{complete:{get:function(){return this._complete}},scene:{get:function(){return this._scene}},search:{get:function(){return this._searchCommand}},selectedSuggestion:{get:function(){return this._selectedSuggestion}},suggestions:{get:function(){return this._suggestions}}}),GeocoderViewModel.prototype.destroy=function(){this._suggestionSubscription.dispose()};var PI=3.141592653589793;function GCJ02WGS84(e,t){if(clampChina(e,t))return[e,t];var n=.006693421622965943,i=transformlat(e-105,t-35),s=transformlng(e-105,t-35),o=t/180*PI,r=Math.sin(o);r=1-n*r*r;var a=Math.sqrt(r);return i=180*i/(6378245*(1-n)/(r*a)*PI),[2*e-(e+(s=180*s/(6378245/a*Math.cos(o)*PI))),2*t-(t+i)]}function transformlat(e,t){var n=2*e-100+3*t+.2*t*t+.1*e*t+.2*Math.sqrt(Math.abs(e));return n+=2*(20*Math.sin(6*e*PI)+20*Math.sin(2*e*PI))/3,n+=2*(20*Math.sin(t*PI)+40*Math.sin(t/3*PI))/3,n+=2*(160*Math.sin(t/12*PI)+320*Math.sin(t*PI/30))/3}function transformlng(e,t){var n=300+e+2*t+.1*e*e+.1*e*t+.1*Math.sqrt(Math.abs(e));return n+=2*(20*Math.sin(6*e*PI)+20*Math.sin(2*e*PI))/3,n+=2*(20*Math.sin(e*PI)+40*Math.sin(e/3*PI))/3,n+=2*(150*Math.sin(e/12*PI)+300*Math.sin(e/30*PI))/3}function clampChina(e,t){return e<72.004||137.8347<e||t<.8293||55.8271<t||!1}function viewerGeocodeMixin(e){var t=document.querySelector(".cesium-viewer"),n=document.createElement("div");n.className="cesium-viewer-toolbar dataEarth-viewer-geoCoder",t.appendChild(n);var i=document.createElement("div");i.className="cesium-viewer-geocoderContainer",n.appendChild(i);var s=new Geocoders({container:i,viewer:e,scene:e.scene});Cesium.defineProperties(e,{geocoder:{get:function(){return s}}})}