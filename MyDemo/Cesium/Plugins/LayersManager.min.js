"use strict";function LayersManager(e,t){var a=new LayersManagerViewModel(t),i=document.createElement("div");this._container=e,this._viewModel=a,(this._element=i).classList.add("dataEarth-viewer-layersManager"),i.setAttribute("data-bind",'css: {expendLayer: _layersManagerDisplay }, style: { top: sceneServiceType ? "55px" : "55px" }'),this._container.appendChild(i);var r=document.createElement("div");r.classList.add("layersManagerOverLay"),r.setAttribute("data-bind","style: { display: _layersManagerOverLay }"),i.appendChild(r);var n=document.createElement("div");n.classList.add("dataEarth-ztree-wrap"),i.appendChild(n);var d=document.createElement("ul");d.id="dataEarth-ztree",d.classList.add("ztree"),n.appendChild(d);var o=document.createElement("div");o.id="dataEarth-ztree-menu",o.style.display="none",i.appendChild(o);var s=document.createElement("ul");o.appendChild(s);var l=document.createElement("li");l.innerText="查看目标",l.classList.add("m_locate"),l.setAttribute("data-bind","click: hanleRightMenuClick.bind($data, 'locate')"),s.appendChild(l);var c=document.createElement("li");c.innerText="添加图层",c.classList.add("m_add"),c.setAttribute("data-bind","click: hanleRightMenuClick.bind($data, 'addLayer')"),s.appendChild(c);var y=document.createElement("li");y.innerText="新建文件夹",y.classList.add("m_addFolder"),y.setAttribute("data-bind","click: hanleRightMenuClick.bind($data, 'addFolder')"),s.appendChild(y);var p=document.createElement("li");p.innerText="重命名",p.classList.add("m_rename"),p.setAttribute("data-bind","click: hanleRightMenuClick.bind($data, 'rename')"),s.appendChild(p);var h=document.createElement("li");h.innerText="编辑",h.classList.add("m_edit"),h.setAttribute("data-bind","click: hanleRightMenuClick.bind($data, 'edit')"),s.appendChild(h);var u=document.createElement("li");u.innerText="位置调整",u.classList.add("m_position"),u.setAttribute("data-bind","click: hanleRightMenuClick.bind($data, 'position')"),s.appendChild(u);var m=document.createElement("li");m.innerText="删除",m.classList.add("m_delete"),m.setAttribute("data-bind","click: hanleRightMenuClick.bind($data, 'delete')"),s.appendChild(m);var v=document.createElement("li");v.innerText="添加标注",v.classList.add("c_point"),v.setAttribute("data-bind","click: hanleRightMenuClick.bind($data, 'point')"),s.appendChild(v);var T=document.createElement("li");T.innerText="添加线",T.classList.add("c_polyline"),T.setAttribute("data-bind","click: hanleRightMenuClick.bind($data, 'polyline')"),s.appendChild(T);var g=document.createElement("li");g.innerText="添加面",g.classList.add("c_polylgon"),g.setAttribute("data-bind","click: hanleRightMenuClick.bind($data, 'polygon')"),s.appendChild(g);var _=document.createElement("li");_.innerText="添加模型",_.classList.add("c_model"),_.setAttribute("data-bind","click: hanleRightMenuClick.bind($data, 'model')"),s.appendChild(_),new PerfectScrollbar(".dataEarth-ztree-wrap"),Cesium.knockout.applyBindings(a,i)}var zLayersTree;function LayersManagerViewModel(e){var n=this;function d(e){"dataEarth-ztree-menu"==e.target.id||0<$(e.target).parents("#dataEarth-ztree-menu").length||$("#dataEarth-ztree-menu").hide()}this._viewer=e,this._onCreatedEvent=new Cesium.Event,this._layersManagerDisplay=!1,this._layersManagerOverLay="none",this.sceneServiceType=void 0,this._isExample=!1,Cesium.knockout.track(this,["_layersManagerDisplay","_layersManagerOverLay","sceneServiceType"]),this._setting={view:{showLine:!1,addDiyDom:function(e,t){var a=$("#"+t.tId+"_switch"),i=$("#"+t.tId+"_ico"),r=$("#"+t.tId+"_check");if(a.remove(),r.remove(),i.before(r),r.before(a),0<t.level){var n="<span style='display: inline-block;width:"+20*t.level+"px'></span>";a.before(n)}}},data:{keep:{leaf:!0,parent:!0},simpleData:{enable:!0,pIdKey:"pid"}},check:{enable:!0,checkboxType:{Y:"ps",N:"ps"}},edit:{enable:!0,showRemoveBtn:!1,showRenameBtn:!1,drag:{isCopy:!1,isMove:!0,prev:!0,inner:!0,next:!0}},callback:{onRightClick:function(e,t,a){if(!a&&"button"!=e.target.tagName.toLowerCase()&&0==$(e.target).parents("a").length)return;zLayersTree.selectNode(a,!1,!0),function(e,t){if(n.sceneServiceType)return;if($("#dataEarth-ztree-menu").show(),$("#dataEarth-ztree-menu ul li").hide(),"root"===e.id)n._isExample||$(".m_add").show(),$(".m_addFolder").show();else if("customLayers"===e.id)n._isExample||($(".c_point").show(),$(".c_polyline").show(),$(".c_polylgon").show(),$(".c_model").show()),$(".m_addFolder").show();else if(e.isParent&&e.getPath().find(function(e){return"customLayers"===e.id}))n._isExample||($(".c_point").show(),$(".c_polyline").show(),$(".c_polylgon").show(),$(".c_model").show()),$(".m_addFolder").show(),$(".m_rename").show(),$(".m_delete").show();else if("root"===e.pid&&e.type===CONSTANT.DE_Vector)$(".m_delete").show();else{if(e.isParent&&e.type===CONSTANT.DE_Vector)return;if(e.type===CONSTANT.DE_Vector)return;e.isParent&&e.getPath().find(function(e){return"customLayers"!==e.id})?($(".m_addFolder").show(),$(".m_rename").show(),$(".m_delete").show(),n._isExample||$(".m_add").show()):($(".m_rename").show(),n._isExample||$(".m_edit").show(),$(".m_delete").show(),e.type===CONSTANT.DE_A3md&&e.id.indexOf("-")<0&&$(".m_position").show())}var a=t.clientX,i=t.clientY,r=$(".dataEarth-viewer-layersManager").offset();$("#dataEarth-ztree-menu").css({top:i-r.top+"px",left:a-r.left+"px"}),$("body").bind("mousedown",d)}(a,e)},onCheck:function(e,t,i){!function t(e){if(e.isParent)e.children&&e.children.forEach(function(e){t(e)});else if(e.isParent&&e.type===CONSTANT.DE_Vector&&!e.layerid){var a=n._viewer.dataSources.getById(e.id);a.show=i.checked}else!function(e){var t;if(e.type===CONSTANT.DE_image)t=n._viewer.imageryLayers.getById(e.id);else if(e.type===CONSTANT.DE_terrain)t=n._viewer.terrainLayers.getById(e.id);else if(e.type===CONSTANT.DE_A3md||e.type===CONSTANT.DE_3Dtiles)t=n._viewer.scene.tilesetLayers.getById(e.id);else if(e.type===CONSTANT.DE_Vector){var a=n._viewer.dataSources.getById(e.layerid);t=a.entities.getById(e.id)}else[CONSTANT.DE_Point,CONSTANT.DE_Polyline,CONSTANT.DE_Polygon,CONSTANT.DE_Model].includes(e.type)&&(t=n._viewer.entities.getById(e.id));t.show=i.checked}(e)}(i)},onClick:function(e,t,a){},beforeDblClick:function(e,t){if(!t||t.isParent)return!1;[CONSTANT.DE_Point,CONSTANT.DE_Polyline,CONSTANT.DE_Polygon,CONSTANT.DE_Model].includes(t.type)&&(i=n._viewer.entities.getById(t.id),n._viewer.flyTo(i,{}));switch(t.type){case CONSTANT.DE_image:i=n._viewer.imageryLayers.getById(t.id),n._viewer.flyTo(i,{});break;case CONSTANT.DE_terrain:i=n._viewer.terrainLayers.getById(t.id),n._viewer.flyTo(i,{});break;case CONSTANT.DE_A3md:case CONSTANT.DE_3Dtiles:i=n._viewer.scene.tilesetLayers.getById(t.id),n._viewer.flyTo(i,{});break;case CONSTANT.DE_Vector:var a=n._viewer.dataSources.getById(t.layerid),i=a.entities.getById(t.id);n._viewer.flyTo(i,new Cesium.HeadingPitchRange(0,-1,50))}},beforeRename:function(e,t,a,i){if(0==a.length)return setTimeout(function(){zLayersTree.cancelEditName(),alert("名称不能为空.")},0),!1;if(CONSTANT.DE_Point===t.type){var r=n._viewer.entities.getById(t.id);r.label.text=a}},beforeDrag:function(e,t){for(var a=0,i=t.length;a<i;a++)if(!1===t[a].drag)return!1;return!0},beforeDrop:function(e,t,a,i){if(null===a||"root"===a.id&&"inner"!==i)return!1;var r=!t[0].getPath().find(function(e){return"customLayers"===e.id}),n=a.getPath().find(function(e){return"customLayers"===e.id});if(r&&n&&"inner"===i)return!1;if(!r&&(!n||"customLayers"===a.id&&"inner"!==i))return!1},onDrop:function(e,t,a,i,r){$("#".concat(a[0].tId,"_switch")).prev().css("width",20*a[0].level)},beforeDragOpen:function(e,t){return"customLayers"!==t.id}}},this._zNodes=[{id:"root",pid:null,name:"我的图层",open:!0,drag:!1,checked:!0},{id:"customLayers",pid:"root",name:"自定义图层",isParent:!0,checked:!0,drag:!1},{id:"googleImage",name:"谷歌影像",type:CONSTANT.DE_image,pid:"root",checked:!0,iconSkin:"iconImage"}],$(document).ready(function(){zLayersTree||($.fn.zTree.init($("#dataEarth-ztree"),n._setting,n._zNodes),zLayersTree=$.fn.zTree.getZTreeObj("dataEarth-ztree"))}),this.hanleRightMenuClick=function(e){switch($("#dataEarth-ztree-menu").hide(),$("body").unbind("mousedown",d),e){case"addLayer":n.addLayer();break;case"addFolder":n.addFolder();break;case"rename":n.modifyFileName();break;case"edit":n.editEntity();break;case"delete":n.deleteLayerAndFolder();break;case"point":n.addPoint();break;case"polyline":n.addPolyline();break;case"polygon":n.addPolygon();break;case"model":n.addModel();break;case"position":n.editPosition()}}}function viewerLayersManagerMixin(e){var t=new LayersManager(document.querySelector(".cesium-viewer"),e);Cesium.defineProperties(e,{layersManager:{get:function(){return t}}})}Cesium.defineProperties(LayersManager.prototype,{viewModel:{get:function(){return this._viewModel}}}),Cesium.defineProperties(LayersManagerViewModel.prototype,{onCreatedEvent:{get:function(){return this._onCreatedEvent}},setDisplayMode:{set:function(e){this._isExample="example"===e}}}),LayersManagerViewModel.prototype.fromJSON=function(e){var d=this;e&&($.fn.zTree.init($("#dataEarth-ztree"),this._setting,e),zLayersTree=$.fn.zTree.getZTreeObj("dataEarth-ztree"),e[0].children.forEach(function(e,t){e.type!==CONSTANT.DE_Vector||e.layerid||function(a,e){var t=d._viewer.dataSources.getById(a.id),i=[{id:a.id,name:a.name,type:CONSTANT.DE_Vector,checked:!!a.checked}];t.entities.values.forEach(function(e){var t={id:e.id,name:e.name,pid:e.parent?e.parent.id:a.id,layerid:a.id,type:CONSTANT.DE_Vector,drag:!1,checked:!!a.checked};i.push(t)});var r=zLayersTree.getNodeByParam("id","root"),n=zLayersTree.getNodeByParam("id",a.id);zLayersTree.removeNode(n),zLayersTree.addNodes(r,e,i)}(e,t)}))},LayersManagerViewModel.prototype.toJSON=function(){var e=zLayersTree.getNodes();return e[0].children.forEach(function(e){e.type!==CONSTANT.DE_Vector||e.layerid||(e.children=[])}),e},LayersManagerViewModel.prototype.addLayer=function(){this.onCreatedEvent.raiseEvent({type:"addLayer"})},LayersManagerViewModel.prototype.addFolder=function(){var e={name:"新建文件夹",isParent:!0};zLayersTree.getSelectedNodes()[0]&&(e.checked=zLayersTree.getSelectedNodes()[0].checked,zLayersTree.addNodes(zLayersTree.getSelectedNodes()[0],-1,e))},LayersManagerViewModel.prototype.modifyFileName=function(){var e=zLayersTree.getSelectedNodes();zLayersTree.editName(e[0])},LayersManagerViewModel.prototype.editEntity=function(){var e,t=zLayersTree.getSelectedNodes()[0];switch([CONSTANT.DE_Point,CONSTANT.DE_Polyline,CONSTANT.DE_Polygon,CONSTANT.DE_Model].includes(t.type)?e=this._viewer.entities.getById(t.id):t.type===CONSTANT.DE_image?e=this._viewer.imageryLayers.getById(t.id):t.type===CONSTANT.DE_A3md&&(e=this._viewer.scene.tilesetLayers.getById(t.id)),t.type){case CONSTANT.DE_image:this.onCreatedEvent.raiseEvent({type:"editImage",value:e});break;case CONSTANT.DE_A3md:this.onCreatedEvent.raiseEvent({type:"editA3md",value:e});break;case CONSTANT.DE_Point:this.onCreatedEvent.raiseEvent({type:"editPoint",value:e});break;case CONSTANT.DE_Polyline:this.onCreatedEvent.raiseEvent({type:"editPolyline",value:e});break;case CONSTANT.DE_Polygon:this.onCreatedEvent.raiseEvent({type:"editPolygon",value:e});break;case CONSTANT.DE_Model:this.onCreatedEvent.raiseEvent({type:"editModal",value:e})}},LayersManagerViewModel.prototype.deleteLayerAndFolder=function(){var t,a=this,i=zLayersTree.getSelectedNodes()[0];function r(e){e.type===CONSTANT.DE_image?(t=a._viewer.imageryLayers.getById(e.id),a._viewer.imageryLayers.remove(t)):e.type===CONSTANT.DE_terrain?(t=a._viewer.terrainLayers.getById(e.id),a._viewer.terrainLayers.remove(t)):e.type===CONSTANT.DE_A3md||e.type===CONSTANT.DE_3Dtiles?(t=a._viewer.scene.tilesetLayers.getById(e.id),a._viewer.scene.tilesetLayers.remove(t)):e.type===CONSTANT.DE_Vector?(t=a._viewer.dataSources.getById(e.id),a._viewer.dataSources.remove(t)):[CONSTANT.DE_Point,CONSTANT.DE_Polyline,CONSTANT.DE_Polygon,CONSTANT.DE_Model].includes(e.type)&&(t=a._viewer.entities.getById(e.id),a._viewer.entities.remove(t)),zLayersTree.removeNode(i)}if(i.isParent&&i.children&&0<i.children.length&&i.type!==CONSTANT.DE_Vector){if(confirm("文件夹非空，确定要删除吗？")){!function e(t){if(t.isParent)for(var a in t.children)e(t.children[a]);else r(t)}(i)}}else r(i);var e=i.getParentNode();0===e.children.length&&zLayersTree.expandNode(e,!1,!1,!1)},LayersManagerViewModel.prototype.editPosition=function(){var e=zLayersTree.getSelectedNodes()[0],t=this._viewer.scene.tilesetLayers.getById(e.id);this.onCreatedEvent.raiseEvent({type:"editPosition",value:t})},LayersManagerViewModel.prototype.addPoint=function(){this.onCreatedEvent.raiseEvent({type:"addPoint"})},LayersManagerViewModel.prototype.addPolyline=function(){this.onCreatedEvent.raiseEvent({type:"addPolyline"})},LayersManagerViewModel.prototype.addPolygon=function(){this.onCreatedEvent.raiseEvent({type:"addPolygon"})},LayersManagerViewModel.prototype.addModel=function(){this.onCreatedEvent.raiseEvent({type:"addModel"})},LayersManagerViewModel.prototype.updateLayersTree=function(a){var e={1:"iconImage",2:"iconTerrain",3:"icon3dmodel",4:"icon3dtile",5:"iconVector",6:"iconA3md",point:"iconPoint",polyline:"iconPolyline",polygon:"iconPolygon",model:"icon3dmodel"},t=zLayersTree.getNodeByParam("id","root"),i=t.getCheckStatus(),r=zLayersTree.getNodeByParam("id","customLayers"),n=r.getCheckStatus();if(!this.sceneServiceType)var d=zLayersTree.getSelectedNodes()[0],o=d.getCheckStatus();if(a.action===ACTION.CREATE)if(a.type===CONSTANT.DE_Vector){var s=[{id:a.value.id,name:a.value.name,type:a.type,checked:!!i.checked}];a.value.show=!!i.checked,a.value.entities.values.forEach(function(e){var t={id:e.id,name:e.name,pid:e.parent?e.parent.id:a.value.id,layerid:a.value.id,type:a.type,drag:!1,checked:!!i.checked};s.push(t)}),zLayersTree.addNodes(t,-1,s)}else if(a.type===CONSTANT.DE_image){var l={id:a.value.imageryProvider.id,name:a.value.imageryProvider.name,type:a.type,checked:!!o.checked,iconSkin:"iconImage"};a.value.show=!!o.checked,zLayersTree.addNodes(d,-1,l,!1)}else if(this.sceneServiceType){l={id:a.value.id,name:a.value.name,type:a.type,checked:!!n.checked,iconSkin:e[a.type]};a.value.show=!!n.checked,zLayersTree.addNodes(r,-1,l,!1)}else if(d.isParent){l={id:a.value.id,name:a.value.name,type:a.type,checked:!!o.checked,iconSkin:e[a.type]};a.value.show=!!o.checked,zLayersTree.addNodes(d,-1,l,!1)}else{l={id:a.value.id,name:a.value.name,type:a.type,checked:!!n.checked,iconSkin:e[a.type]};a.value.show=!!n.checked,zLayersTree.addNodes(r,-1,l,!1)}if(a.action===ACTION.UPDATA){var c=zLayersTree.getNodesByParam("id",a.value.id)[0];c.name=a.value.name,zLayersTree.updateNode(c)}};