"use strict";function PlacePolygon(e,i){var t=document.createElement("div");t.classList.add("dataEarth-polygon"),t.style.display="none",e.appendChild(t);t.innerHTML="<dl>      <dt>操作</dt>      <dd class=\"option\"><div class='polygonEdit'><a data-bind='click: startDrawingPolygon, css: { current: _editAction === PolygonEditorAction.CREATE }' title='新增绘制'>新增绘制</a><a data-bind='click: setEditType(PolygonEditType.EA_HANDLE_MOVE), css: { current: _editType === PolygonEditType.EA_HANDLE_MOVE}'>平移节点</a><a data-bind='click: setEditType(PolygonEditType.EA_HANDLE_MOVE_Z), css: { current: _editType === PolygonEditType.EA_HANDLE_MOVE_Z}'>升降节点</a><a data-bind='click: setEditType(PolygonEditType.EA_POLYGON_EXTRUDED), css: { current: _editType === PolygonEditType.EA_POLYGON_EXTRUDED}'>拉伸对象</a><a data-bind='click: setEditType(PolygonEditType.EA_POLYGON_MOVE_Z), css: { current: _editType === PolygonEditType.EA_POLYGON_MOVE_Z}'>升降对象</a></div>"+'        <div class="checkBox" style="padding: 0px 18px 5px;">          <input type="checkbox" id="polygonCheck" data-bind="checked: !cameraController, event: { change: cameraControllerChange }">           <label for="polygonCheck" class="lightObj">连续绘制</label>        </div></div></dd>    </dl><dl>      <dt>名称</dt>      <dd><input type="text" class="elementName" data-bind="value: polygonName, event: {input: modifyPolygonName}, valueUpdate: \'input\'""></dd>    </dl>    <dl>        <dt>样式</dt>        <dd>          <div class=\'pickerWrap\'>            填充颜色 <span class="colorPicker"><span id="polygonColor"></span><label for="" data-bind="text: polygonColor">#fff</label></span>          </div>          <div class=\'sliderWrap\'>            不透明度 <span id="polygonColorAlpha" class="sliderAlpha"></span>          </div>          <div class=\'pickerWrap\'>            边框颜色 <span class="colorPicker"><span id="polygonOutlineColor"></span><label for="" data-bind="text: polygonOutlineColor">#fff</label></span>          </div>          <div class=\'sliderWrap\'>            不透明度 <span id="polygonOutlineColorAlpha" class="sliderAlpha"></span>          </div>        </dd>      </dl>';var o=new PlacePolygonViewModel(i.scene,i,t);this._viewModel=o,Cesium.knockout.applyBindings(o,t)}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Cesium.defineProperties(PlacePolygon.prototype,{viewModel:{get:function(){return this._viewModel}}});var polygonColorPicker,polygonColorAlphaSlider,polygonOutlineColorPicker,polygonOutlineAlphaSlider,ellipsoid=Cesium.Ellipsoid.WGS84,PolygonEditorAction={CREATE:1,EDIT:2,NONE:3},PolygonEditType={EA_HANDLE_MOVE:0,EA_HANDLE_MOVE_Z:1,EA_POLYGON_MOVE_Z:2,EA_POLYGON_EXTRUDED:3,NONE:4},PolygonChangeablePrimitive=function(){function e(){}return e.prototype.initialiseOptions=function(e){fillOptions(this,e),this._ellipsoid=void 0,this._granularity=void 0,this._height=void 0,this._textureRotationAngle=void 0,this._id=void 0,this._classificationType=void 0,this._createPlacePolygonPrimitive=!0,this._primitive=void 0,this._outlinePolygon=void 0,this.setStrokeStyle(Cesium.Color.fromCssColorString("white"),this.strokeWidth)},e.prototype.setAttribute=function(e,i){this[e]=i,this._createPlacePolygonPrimitive=!0},e.prototype.getAttribute=function(e){return this[e]},e.prototype.update=function(e){if(!Cesium.defined(this.ellipsoid))throw new Cesium.DeveloperError("this.ellipsoid must be defined.");if(!Cesium.defined(this.appearance))throw new Cesium.DeveloperError("this.material must be defined.");if(this.granularity<0)throw new Cesium.DeveloperError("this.granularity and scene2D/scene3D overrides must be greater than zero.");if(this.show&&(this._createPlacePolygonPrimitive||Cesium.defined(this._primitive))){if(this._createPlacePolygonPrimitive||this._ellipsoid!==this.ellipsoid||this._granularity!==this.granularity||this._height!==this.height||this._textureRotationAngle!==this.textureRotationAngle||this._id!==this.id){var i=this.getGeometry();if(!i)return;if(this._createPlacePolygonPrimitive=!1,this._ellipsoid=this.ellipsoid,this._granularity=this.granularity,this._height=this.height,this._textureRotationAngle=this.textureRotationAngle,this._id=this.id,this._classificationType=this._viewModel.classificationType,this._primitive=this._primitive&&this._primitive.destroy(),this.appearance.material=this._viewModel._defaultMaterial,Cesium.defined(this._classificationType)?this._primitive=new Cesium.GroundPrimitive({geometryInstances:new Cesium.GeometryInstance({geometry:i,id:this.id,pickPrimitive:this,attributes:{color:Cesium.ColorGeometryInstanceAttribute.fromColor(this._viewModel._defaultMaterial.uniforms.color)}}),asynchronous:this.asynchronous,classificationType:this._classificationType}):this._primitive=new Cesium.Primitive({geometryInstances:new Cesium.GeometryInstance({geometry:i,id:this.id,pickPrimitive:this}),appearance:this.appearance,asynchronous:this.asynchronous}),Cesium.defined(this._selectedEntity))switch(this._viewModel._editType){case PolygonEditType.EA_POLYGON_EXTRUDED:var t=this.positions[0],o=Cesium.Cartographic.fromCartesian(t);if(this._selectedEntity.polygon.relativeExtruded){var n,s=this._selectedEntity.polygon.hierarchy.getValue();n=Cesium.defined(s.positions)?s.positions[0]:s[0];var l=Cesium.Cartographic.fromCartesian(n);this._selectedEntity.polygon.extrudedHeight.setValue(o.height-l.height)}else this._selectedEntity.polygon.extrudedHeight.setValue(o.height);break;default:s=[];for(var r=0;r<this.positions.length;r++)s.push(this.positions[r].clone());this._selectedEntity.polygon.hierarchy.setValue(s)}}var a=this._primitive;a.debugShowBoundingVolume=this.debugShowBoundingVolume,a.update(e),this._outlinePolygon=this._outlinePolygon&&this._outlinePolygon.destroy(),this.strokeColor&&this.getOutlineGeometry&&(this._outlinePolygon=new Cesium.Primitive({geometryInstances:new Cesium.GeometryInstance({geometry:this.getOutlineGeometry(),attributes:{color:Cesium.ColorGeometryInstanceAttribute.fromColor(Cesium.Color.fromCssColorString(this._viewModel.polygonOutlineColor).withAlpha(this._viewModel.polygonOutlineColorAlpha))}}),appearance:new Cesium.PerInstanceColorAppearance({flat:!0,renderState:{depthTest:{enabled:!0}}}),asynchronous:this.asynchronous})),this._outlinePolygon&&this._outlinePolygon.update(e)}},e.prototype.isDestroyed=function(){return!1},e.prototype.destroy=function(){return this._primitive=this._primitive&&this._primitive.destroy(),Cesium.destroyObject(this)},e.prototype.setStrokeStyle=function(e,i){this.strokeColor&&this.strokeColor.equals(e)&&this.strokeWidth==i||(this._createPlacePolygonPrimitive=!0,this.strokeColor=e,this.strokeWidth=i)},e}(),PlacePolygonPrimitive=function(){function e(e){this.initialiseOptions(e),this.isPolygon=!0,this.isEditPrimitive=!0}return(e.prototype=new PolygonChangeablePrimitive).setPositions=function(e){this.setAttribute("positions",e)},e.prototype.getPositions=function(){return this.getAttribute("positions")},e.prototype.offsetZ=function(e){if(Cesium.defined(this.positions)&&!(this.positions.length<3))for(var i=0;i<this.positions.length;i++){var t=Cesium.Cartographic.fromCartesian(this.positions[i]);t.height+=e,this.positions[i]=Cesium.Cartesian3.fromRadians(t.longitude,t.latitude,t.height)}},e.prototype.getGeometry=function(){if(Cesium.defined(this.positions)&&!(this.positions.length<3)){for(var e=[],i=0;i<this.positions.length;i++)e.push(this.positions[i].clone());return Cesium.defined(this._classificationType)?Cesium.PolygonGeometry.fromPositions({positions:e,vertexFormat:Cesium.PerInstanceColorAppearance.VERTEX_FORMAT}):Cesium.PolygonGeometry.fromPositions({positions:e,height:this.height,vertexFormat:Cesium.EllipsoidSurfaceAppearance.VERTEX_FORMAT,stRotation:this.textureRotationAngle,ellipsoid:this.ellipsoid,granularity:this.granularity,perPositionHeight:!0})}},e.prototype.getOutlineGeometry=function(){return Cesium.PolygonOutlineGeometry.fromPositions({positions:this.getPositions(),perPositionHeight:!0})},e}();function PlacePolygonViewModel(e,i,t){this.ellipsoid=Cesium.Ellipsoid.WGS84;var o=e.canvas;this._eventHandler=void 0,this._scene=e,this._canvas=o,this._viewer=i,this._element=t,this.cameraController=!0,this._selectedEntity=void 0,this._editGeometry=void 0,this._onCreatedEvent=new Cesium.Event,this._onEditHandleMoveEvent=new Cesium.Event,this._editAction=PolygonEditorAction.CREATE,this._editType=PolygonEditType.NONE,Cesium.knockout.track(this,["polygonName","polygonColor","polygonColorAlpha","polygonOutlineColor","polygonOutlineColorAlpha","_selectedEntity","_editType","cameraController","_editAction"]),this.polygonName="未命名面",this.polygonColor="#ffff00",this.polygonColorAlpha=1,this.polygonOutlineColor="#ff0000",this.polygonOutlineColorAlpha=1;var n=this;$(document).ready(function(){var e={preview:!0,opacity:!1,hue:!0,interaction:{hex:!1,rgba:!1,hsla:!1,hsva:!1,cmyk:!1,input:!0,clear:!1,save:!0}};polygonColorPicker=Pickr.create({el:"#polygonColor",default:n.polygonColor,components:e,strings:{save:"保存"},onSave:function(e,i){n.polygonColor=e.toHEX().toString(),n._editAction===PolygonEditorAction.CREATE&&n.setAction(n._editAction),n.modifyPolygonColor(e.toHEX().toString())}}),layui.use("slider",function(){var e=layui.slider;polygonColorAlphaSlider=e.render({elem:"#polygonColorAlpha",value:100,setTips:function(e){return e+"%"},change:function(e){n.polygonColorAlpha=parseInt(e)/100,n._editAction===PolygonEditorAction.CREATE&&n.setAction(n._editAction),n.modifyPolygonColorAlpha(parseInt(e)/100)}})}),polygonOutlineColorPicker=Pickr.create({el:"#polygonOutlineColor",default:n.polygonOutlineColor,components:e,strings:{save:"保存"},onSave:function(e,i){n.polygonOutlineColor=e.toHEX().toString(),n.modifyOutlineColor(e.toHEX().toString())}}),layui.use("slider",function(){var e=layui.slider;polygonOutlineAlphaSlider=e.render({elem:"#polygonOutlineColorAlpha",value:100,setTips:function(e){return e+"%"},change:function(e){n.polygonOutlineColorAlpha=parseInt(e)/100,n.modifyOutlineColorAlpha(parseInt(e)/100)}})})}),this.enhancePrimitives(),enhanceWithListeners(this),this.restDefaultOptions()}Cesium.defineProperties(PlacePolygonViewModel.prototype,{scene:{get:function(){return this._scene}},onCreatedEvent:{get:function(){return this._onCreatedEvent}},onEditHandleMoveEvent:{get:function(){return this._onEditHandleMoveEvent}},selectedEntity:{get:function(){return this._selectedEntity},set:function(e){if(Cesium.defined(this._selectedEntity)&&Cesium.defined(this._selectedEntity.primitive)&&Cesium.defined(this._selectedEntity.primitive._markers)&&!this._selectedEntity.primitive._editMode&&this.cleanUp(),Cesium.defined(e))if(this._selectedEntity=e,Cesium.defined(e.polygon)){this.cleanUp();var i=e.polygon.hierarchy.getValue();Cesium.defined(i.positions)||(i={positions:i}),this._defaultMaterial.uniforms.color=Cesium.Color.YELLOW.withAlpha(0),this.setEditType(PolygonEditType.EA_HANDLE_MOVE),this.polygonName=e.name;var t=e.polygon.material.color.getValue(),o=new Cesium.Color(t.red,t.green,t.blue,1);this.polygonColor=o.toCssColorString(),polygonColorPicker.setColor(this.polygonColor),this.polygonColorAlpha=t.alpha,polygonColorAlphaSlider.setValue(100*this.polygonColorAlpha);var n=e.polygon.outlineColor.getValue(),s=new Cesium.Color(n.red,n.green,n.blue,1);this.polygonOutlineColor=s.toCssColorString(),polygonOutlineColorPicker.setColor(this.polygonOutlineColor),this.polygonOutlineColorAlpha=n.alpha,polygonOutlineAlphaSlider.setValue(100*this.polygonOutlineColorAlpha),Cesium.defined(e.polygon.classificationType)&&(this.classificationType=e.polygon.classificationType.getValue())}else this._selectedEntity=void 0;else this._selectedEntity=void 0}},editGeometry:{get:function(){return this._editGeometry},set:function(e){if(null!=(this._editGeometry=e)&&e instanceof Cesium.PolygonGeometry){this.cleanUp(),this._editType=PolygonEditType.EA_HANDLE_MOVE,this._editAction=PolygonEditorAction.EDIT;var i={positions:e._polygonHierarchy.positions};i=copyOptions(i,this.defaultSurfaceOptions);var t=new PlacePolygonPrimitive(i);this._scene.primitives.add(t),t.setEditable(),t.setEditMode(!0)}}}}),PlacePolygonViewModel.prototype.cleanUp=function(){for(var e=this._scene.primitives,i=e._primitives.length-1;0<i;i--){var t=e._primitives[i];(t.isPolygonEditPrimitive||Cesium.defined(t._createPlacePolygonPrimitive))&&e.remove(t)}},PlacePolygonViewModel.prototype.restDefaultOptions=function(){this._defaultMaterial=Cesium.Material.fromType(Cesium.Material.ColorType);var e=Cesium.Color.fromCssColorString(this.polygonColor);e=e.withAlpha(this.polygonColorAlpha),this._defaultMaterial.uniforms.color=e,this._defaultMaterialProperty=e,this.defaultSurfaceOptions={ellipsoid:Cesium.Ellipsoid.WGS84,textureRotationAngle:0,height:0,asynchronous:!0,show:!0,debugShowBoundingVolume:!1,appearance:new Cesium.EllipsoidSurfaceAppearance({aboveGround:!1,material:this._defaultMaterial}),granularity:Math.PI/180},this._classificationType=void 0},PlacePolygonViewModel.prototype.setAction=function(e){this.restDefaultOptions(),this._editAction=e;var l=this;switch(e){case PolygonEditorAction.CREATE:this._startDrawingPolygon({callback:function(e){for(var i=Number.MAX_VALUE,t=0,o=0;o<e.length;o++){var n=e[o],s=Cesium.Cartographic.fromCartesian(n);i=Math.min(i,s.height),t=Math.max(t,s.height)}l.executeListeners({name:"polygonCreated",positions:e,minHeight:i,maxHeight:t})}})}},PlacePolygonViewModel.prototype.setEditType=function(e){if(Cesium.defined(this.selectedEntity))switch(this._editType=e,this._editAction=PolygonEditorAction.EDIT,console.log(this._editAction),e){case PolygonEditType.EA_POLYGON_EXTRUDED:if(Cesium.defined(this._selectedEntity)&&Cesium.defined(this._selectedEntity.polygon)){this.cleanUp();var i=this._selectedEntity.polygon.hierarchy.getValue();Cesium.defined(i.positions)||(i={positions:i});for(var t=[],o=0;o<i.positions.length;o++){var n=i.positions[o],s=Cesium.Cartographic.fromCartesian(n);Cesium.defined(this._selectedEntity.polygon.relativeExtruded)?s.height+=this._selectedEntity.polygon.extrudedHeight.getValue():(this._selectedEntity.polygon.relativeExtruded=!0,this._selectedEntity.polygon.extrudedHeight=0);var l=Cesium.Cartographic.toCartesian(s);t.push(l)}var r={positions:t};r=copyOptions(r,this.defaultSurfaceOptions);var a=new PlacePolygonPrimitive(r);Cesium.defined(this._selectedEntity.primitive)&&Cesium.defined(this._selectedEntity.primitive._markers)&&this._selectedEntity.primitive._markers.remove(),this._scene.primitives.remove(this._selectedEntity.primitive),this._scene.primitives.add(a),a.setEditable(),a.setEditMode(!0),(this._selectedEntity.primitive=a)._selectedEntity=this._selectedEntity,a._viewModel=this}break;default:if(Cesium.defined(this._selectedEntity)&&Cesium.defined(this._selectedEntity.polygon)){this.cleanUp();i=this._selectedEntity.polygon.hierarchy.getValue();Cesium.defined(i.positions)||(i={positions:i}),i=copyOptions(i,this.defaultSurfaceOptions);a=new PlacePolygonPrimitive(i);Cesium.defined(this._selectedEntity.primitive)&&Cesium.defined(this._selectedEntity.primitive._markers)&&this._selectedEntity.primitive._markers.remove(),this._scene.primitives.remove(this._selectedEntity.primitive),this._scene.primitives.add(a),a.setEditable(),a.setEditMode(!0),(this._selectedEntity.primitive=a)._selectedEntity=this._selectedEntity,a._viewModel=this}}},PlacePolygonViewModel.prototype.toggleInspector=function(){this.inspectorVisible=!this.inspectorVisible},PlacePolygonViewModel.prototype.isDestroyed=function(){return!1},PlacePolygonViewModel.prototype.destroy=function(){this._eventHandler.destroy(),this._removePostRenderEvent();var i=this;return this._definedProperties.forEach(function(e){Cesium.knockout.getObservable(i,e).dispose()}),destroyObject(this)},PlacePolygonViewModel.prototype.initialiseHandlers=function(){var a=this._scene,d=this;this._eventHandler=new Cesium.ScreenSpaceEventHandler(a.canvas);var o,c,e=this._eventHandler;function p(e,i){if(1!=d._handlersMuted){var t=a.pick(i);t&&t.primitive&&t.primitive[e]&&t.primitive[e](i)}}e.setInputAction(function(e){p("leftClick",e.position)},Cesium.ScreenSpaceEventType.LEFT_CLICK),e.setInputAction(function(e){p("leftDoubleClick",e.position)},Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);var h=1;e.setInputAction(function(e){if(d._editAction!=PolygonEditorAction.NONE&&1!=d._handlersMuted)if(!Cesium.defined(c)||d._editType!=PolygonEditType.EA_POLYGON_MOVE_Z&&d._editType!=PolygonEditType.EA_POLYGON_EXTRUDED){var i=a.pick(e.endPosition);!o||i&&o==i.primitive||((!o.isDestroyed||!o.isDestroyed())&&o.mouseOut(e.endPosition),o=null),i&&i.primitive&&((i=i.primitive).mouseOut&&(o=i),i.mouseMove&&i.mouseMove(e))}else{if(0==e.startPosition.y)return;var t=e.startPosition.y-e.endPosition.y;Cesium.defined(c._createPlacePolygonPrimitive)&&(c.offsetZ(t*h),c._markers.updateBillboardsPositions(c.positions),c._createPlacePolygonPrimitive=!0,d.onEditHandleMoveEvent.raiseEvent({positions:c.positions}))}},Cesium.ScreenSpaceEventType.MOUSE_MOVE),e.setInputAction(function(e){c=null,p("leftUp",e.position),d._scene.screenSpaceCameraController.enableInputs=!0,Cesium.defined(d.selectedEntity)||(d._editType=PolygonEditType.NONE)},Cesium.ScreenSpaceEventType.LEFT_UP),e.setInputAction(function(e){c=null,p("leftDown",e.position);var i=a.pick(e.position);if(Cesium.defined(i)&&Cesium.defined(i.id)&&Cesium.defined(i.id.primitive)&&(c=i.id.primitive),d._editAction==PolygonEditorAction.EDIT&&(Cesium.defined(c)||Cesium.defined(i)&&Cesium.defined(i.primitive))){d._scene.screenSpaceCameraController.enableInputs=!1;var t=d._scene.pickGlobe(e.position);if(t){var o=new Cesium.BoundingRectangle;o.x=0,o.y=0,o.width=d._scene._context.drawingBufferWidth,o.height=d._scene._context.drawingBufferHeight;var n=Cesium.Cartographic.fromCartesian(t),s=Cesium.Cartographic.fromRadians(n.longitude,n.latitude,0),l=Cesium.DEUtility.project(t,d._scene.camera,o),r=Cesium.DEUtility.project(Cesium.Cartographic.toCartesian(s),d._scene.camera,o);h=n.height/(l.y-r.y)}}},Cesium.ScreenSpaceEventType.LEFT_DOWN)},PlacePolygonViewModel.prototype.setListener=function(e,i,t){e[i]=t},PlacePolygonViewModel.prototype.muteHandlers=function(e){this._handlersMuted=e},PlacePolygonViewModel.prototype.startDrawing=function(e){this.disableAllEditMode(),this.editCleanUp&&this.editCleanUp(),this.editCleanUp=e,this.muteHandlers(!0)},PlacePolygonViewModel.prototype.stopDrawing=function(){this.editCleanUp&&(this.editCleanUp(),this.editCleanUp=null),this.muteHandlers(!1)},PlacePolygonViewModel.prototype.disableAllEditMode=function(){this.setEdited(void 0)},PlacePolygonViewModel.prototype.setEdited=function(e){this._editedSurface&&!this._editedSurface.isDestroyed()&&this._editedSurface.setEditMode(!1),this._editedSurface=e};var PolygonHandle=function(e,i){this._viewModel=e,this._scene=e._scene,this._options=copyOptions(i,{iconUrl:"".concat(e._viewer._basePath,"/Plugins/assets/dragIcon.png"),shiftX:0,shiftY:0});var t=new Cesium.BillboardCollection;t.isPolygonEditPrimitive=!0,this._scene.primitives.add(t),this._billboards=t,this._orderedBillboards=[]};function clone(e,i){if(null==e||"object"!=_typeof(e))return e;if(e.constructor!=Object&&e.constructor!=Array)return e;if(e.constructor==Date||e.constructor==RegExp||e.constructor==Function||e.constructor==String||e.constructor==Number||e.constructor==Boolean)return new e.constructor(e);for(var t in i=i||new e.constructor,e)i[t]=void 0===i[t]?clone(e[t],null):i[t];return i}function fillOptions(e,i){var t;for(t in e=e||{},i)void 0===e[t]&&(e[t]=clone(i[t]))}function copyOptions(e,i){var t,o=clone(e);for(t in i)void 0===o[t]&&(o[t]=clone(i[t]));return o}function setListener(e,i,t){e[i]=t}function enhanceWithListeners(e){e._listeners={},e.addListener=function(e,i){return this._listeners[e]=this._listeners[e]||[],this._listeners[e].push(i),this._listeners[e].length},e.executeListeners=function(e,i){if(this._listeners[e.name]&&0<this._listeners[e.name].length)for(var t=0;t<this._listeners[e.name].length;t++)this._listeners[e.name][t](e);else i&&i(e)}}function viewerPlacePolygonMixin(e){var i=new PlacePolygon(document.querySelector(".cesium-viewer"),e);Cesium.defineProperties(e,{placePolygon:{get:function(){return i}}})}PolygonHandle.prototype.createBillboard=function(e,c){var p=this._billboards.add({show:!0,position:e,pixelOffset:new Cesium.Cartesian2(this._options.shiftX,this._options.shiftY),eyeOffset:new Cesium.Cartesian3(0,0,0),horizontalOrigin:Cesium.HorizontalOrigin.CENTER,verticalOrigin:Cesium.VerticalOrigin.CENTER,scale:1.2,image:this._options.iconUrl});if(this._viewModel._editAction==PolygonEditorAction.EDIT&&(p.disableDepthTestDistance=1e4,Cesium.defined(this._viewModel.defaultSurfaceOptions.classificationType)?this._billboards._depthMask=!1:this._billboards._depthMask=!0),c){var h=function(e){i.enableRotate=e},y=function(){for(var e=0,i=u._orderedBillboards.length;e<i&&u._orderedBillboards[e]!=p;++e);return e},u=this,i=this._scene.screenSpaceCameraController;if(c.dragHandlers){u=this;var g=Cesium.Ellipsoid.WGS84,f=1;setListener(p,"leftDown",function(e){function n(e){i.destroy(),h(!0),c.dragHandlers.onDragEnd&&c.dragHandlers.onDragEnd(y(),e)}var i=new Cesium.ScreenSpaceEventHandler(u._scene.canvas);switch(i.setInputAction(function(e){var i=void 0;switch(u._viewModel._editType){case PolygonEditType.EA_HANDLE_MOVE:i=Cesium.defined(u._viewModel.defaultSurfaceOptions.classificationType)?u._scene.pickGlobe(e.endPosition):u._scene.camera.pickEllipsoid(e.endPosition,g);break;case PolygonEditType.EA_HANDLE_MOVE_Z:if(0==e.startPosition.y)return;var t=e.startPosition.y-e.endPosition.y,o=Cesium.Cartographic.fromCartesian(p.position);o.height+=t*f,i=Cesium.Cartesian3.fromRadians(o.longitude,o.latitude,o.height)}i?function(e){p.position=e;for(var i=0,t=u._orderedBillboards.length;i<t&&u._orderedBillboards[i]!=p;++i);c.dragHandlers.onDrag&&c.dragHandlers.onDrag(y(),e)}(i):n(i)},Cesium.ScreenSpaceEventType.MOUSE_MOVE),i.setInputAction(function(e){n(u._scene.pickGlobe(e.position))},Cesium.ScreenSpaceEventType.LEFT_UP),h(!1),u._viewModel._editType){case PolygonEditType.EA_HANDLE_MOVE:if(o=p.position){var t=Cesium.Cartesian3.magnitude(o);g=new Cesium.Ellipsoid(t,t,t)}break;case PolygonEditType.EA_HANDLE_MOVE_Z:var o;if(o=p.position){var s=new Cesium.BoundingRectangle;s.x=0,s.y=0,s.width=u._viewModel._scene._context.drawingBufferWidth,s.height=u._viewModel._scene._context.drawingBufferHeight;var l=Cesium.Cartographic.fromCartesian(o),r=Cesium.Cartographic.fromRadians(l.longitude,l.latitude,0),a=Cesium.DEUtility.project(o,u._viewModel._scene.camera,s),d=Cesium.DEUtility.project(Cesium.Cartographic.toCartesian(r),u._viewModel._scene.camera,s);f=l.height/(a.y-d.y)}}})}c.onDoubleClick&&setListener(p,"leftDoubleClick",function(e){c.onDoubleClick(y())}),c.onClick&&setListener(p,"leftClick",function(e){c.onClick(y())})}return p},PolygonHandle.prototype.insertBillboard=function(e,i,t){this._orderedBillboards.splice(e,0,this.createBillboard(i,t))},PolygonHandle.prototype.addBillboard=function(e,i){this._orderedBillboards.push(this.createBillboard(e,i))},PolygonHandle.prototype.addBillboards=function(e,i){for(var t=0;t<e.length;t++)this.addBillboard(e[t],i)},PolygonHandle.prototype.updateBillboardsPositions=function(e){for(var i=0;i<e.length;i++)this.getBillboard(i).position=e[i]},PolygonHandle.prototype.countBillboards=function(){return this._orderedBillboards.length},PolygonHandle.prototype.getBillboard=function(e){return this._orderedBillboards[e]},PolygonHandle.prototype.removeBillboard=function(e){this._billboards.remove(this.getBillboard(e)),this._orderedBillboards.splice(e,1)},PolygonHandle.prototype.remove=function(){this._scene.primitives.remove(this._billboards)},PolygonHandle.prototype.setOnTop=function(){this._scene.primitives.raiseToTop(this._billboards)},PlacePolygonViewModel.prototype.startDrawingPolygon=function(){this._editType=PolygonEditType.NONE,this.setAction(PolygonEditorAction.CREATE)},PlacePolygonViewModel.prototype._startDrawingPolygon=function(e){e=copyOptions(e,this.defaultSurfaceOptions);this.startDrawingPolyshape(e)},PlacePolygonViewModel.prototype.startDrawingPolyshape=function(e){this.startDrawing(function(){i.remove(r),d.remove(),t.destroy()});var s=this,l=this._scene,i=l.primitives,r=new PlacePolygonPrimitive(e);r._viewModel=this,r.asynchronous=!1,i.add(r);var a=[],d=new PolygonHandle(this,{iconUrl:"".concat(s._viewer._basePath,"/Plugins/assets/dragIcon.png"),shiftX:0,shiftY:0}),t=new Cesium.ScreenSpaceEventHandler(l.canvas),c=!1;t.setInputAction(function(e){if(null!=e.position){var i=l.pickGlobe(e.position);if(i){if(0==a.length&&(a.push(i.clone()),d.addBillboard(a[0])),3<=a.length){for(var t=[],o=0;o<a.length;o++)t.push(a[o].clone());r.positions=t,r._createPlacePolygonPrimitive=!0}a.push(i.clone()),d.addBillboard(i.clone()),c=!0,s._scene.screenSpaceCameraController.enableInputs=s.cameraController}}},Cesium.ScreenSpaceEventType.LEFT_DOWN),t.setInputAction(function(e){c=!1,s._scene.screenSpaceCameraController.enableInputs=!0},Cesium.ScreenSpaceEventType.LEFT_UP),t.setInputAction(function(e){var i=e.endPosition;if(null!=i)if(0==a.length);else{var t=l.pickGlobe(i);if(t)if(c&&!s.cameraController){if(0==a.length&&(a.push(t.clone()),d.addBillboard(a[0])),3<=a.length){for(var o=[],n=0;n<a.length;n++)o.push(a[n].clone());r.positions=o,r._createPlacePolygonPrimitive=!0}a.push(t.clone()),d.addBillboard(t.clone())}else{if(a.pop(),a.push(t.clone()),3<=a.length){for(o=[],n=0;n<a.length;n++)o.push(a[n].clone());r.positions=o,r._createPlacePolygonPrimitive=!0}d.getBillboard(a.length-1).position=t.clone()}}},Cesium.ScreenSpaceEventType.MOUSE_MOVE),t.setInputAction(function(e){var i=e.position;if(null!=i){if(a.length<5)return;l.pickGlobe(i)&&(s.stopDrawing(),a.splice(a.length-2,2),s.createPolygonEntity(a),s.setEditType(PolygonEditType.EA_HANDLE_MOVE))}},Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK),t.setInputAction(function(e){s.stopDrawing(),a.splice(a.length-1,1),s.createPolygonEntity(a),s.setEditType(PolygonEditType.EA_HANDLE_MOVE)},Cesium.ScreenSpaceEventType.RIGHT_CLICK)},PlacePolygonViewModel.prototype.enhancePrimitives=function(){var l=this;function i(e){if(this._editMode!=e)if(e){l.setEdited(this);var t=l._scene,o=this;if(null==this._markers){var n=function(){o.executeListeners({name:"onEdited",positions:o.positions})},i=new PolygonHandle(l,{iconUrl:"".concat(l._viewer._basePath,"/Plugins/assets/dragIcon.png"),shiftX:0,shiftY:0}),s={dragHandlers:{onDrag:function(e,i){o.positions[e]=i,o._createPlacePolygonPrimitive=!0,l.onEditHandleMoveEvent.raiseEvent({positions:o.positions})},onDragEnd:function(e,i){o._createPlacePolygonPrimitive=!0,l.onEditHandleMoveEvent.raiseEvent({positions:o.positions}),n()}},onDoubleClick:function(e){o.positions.length<4||l._editType==PolygonEditType.EA_POLYGON_EXTRUDED||(o.positions.splice(e,1),o._createPlacePolygonPrimitive=!0,i.removeBillboard(e),l.onEditHandleMoveEvent.raiseEvent({positions:o.positions}),n())}};i.addBillboards(o.positions,s),this._markers=i,this._globeClickhandler=new Cesium.ScreenSpaceEventHandler(t.canvas),this._globeClickhandler.setInputAction(function(e){var i=t.pick(e.position);i&&i.primitive||(o.setEditMode(!1),t.primitives.remove(o))},Cesium.ScreenSpaceEventType.LEFT_CLICK),i.setOnTop()}this._editMode=!0}else null!=this._markers&&(this._markers.remove(),this._markers=null,this._globeClickhandler.destroy()),this._editMode=!1}Cesium.Billboard.prototype.setEditable=function(){if(!this._editable){this._editable=!0;var o=this,n=this;setListener(o,"leftDown",function(e){function t(e){i.destroy(),s(!0),n.executeListeners({name:"dragEnd",positions:e})}var i=new Cesium.ScreenSpaceEventHandler(o._scene.canvas);i.setInputAction(function(e){var i=l._scene.pickGlobe(e.endPosition);i?function(e){o.position=e,n.executeListeners({name:"drag",positions:e})}(i):t(i)},Cesium.ScreenSpaceEventType.MOUSE_MOVE),i.setInputAction(function(e){t(l._scene.camera.pickGlobe(e.position))},Cesium.ScreenSpaceEventType.LEFT_UP),s(!1)}),enhanceWithListeners(o)}function s(e){l._scene.screenSpaceCameraController.enableRotate=e}},PlacePolygonPrimitive.prototype.setEditable=function(){var e=this;e.asynchronous=!1;l._scene;l.registerEditableShape(e),e.setEditMode=i,enhanceWithListeners(e),e.setEditMode(!1)}},PlacePolygonViewModel.prototype.createPolygonEntity=function(e){if(!(e.length<3)){var i=Cesium.Color.fromCssColorString(this.polygonOutlineColor);i=i.withAlpha(this.polygonOutlineColorAlpha);var t=this._viewer.entities.add({name:this.polygonName,polygon:{hierarchy:{positions:e},material:this._defaultMaterialProperty,outline:!0,outlineColor:i,perPositionHeight:null==this.classificationType,classificationType:this.classificationType}});this.selectedEntity=t,"undefined"!=typeof ACTION&&this.onCreatedEvent.raiseEvent({action:ACTION.CREATE,type:CONSTANT.DE_Polygon,value:t})}},PlacePolygonViewModel.prototype.modifyPolygonName=function(){Cesium.defined(this.selectedEntity)&&(this.selectedEntity.name=this.polygonName,"undefined"!=typeof ACTION&&this.onCreatedEvent.raiseEvent({action:ACTION.UPDATA,type:CONSTANT.DE_Polygon,value:this.selectedEntity}))},PlacePolygonViewModel.prototype.modifyPolygonColor=function(e){Cesium.defined(this.selectedEntity)&&Cesium.defined(this.selectedEntity.polygon)&&(console.log(e),this.selectedEntity.polygon.material.color=Cesium.Color.fromCssColorString(e))},PlacePolygonViewModel.prototype.modifyPolygonColorAlpha=function(e){if(Cesium.defined(this.selectedEntity)&&Cesium.defined(this.selectedEntity.polygon)){var i=this.selectedEntity.polygon.material.color.getValue();console.log(i),this.selectedEntity.polygon.material.color=i.withAlpha(e)}},PlacePolygonViewModel.prototype.modifyOutlineColor=function(e){Cesium.defined(this.selectedEntity)&&Cesium.defined(this.selectedEntity.polygon)&&Cesium.defined(this.selectedEntity.polygon.material)&&(this.selectedEntity.polygon.outlineColor=Cesium.Color.fromCssColorString(e))},PlacePolygonViewModel.prototype.modifyOutlineColorAlpha=function(e){if(Cesium.defined(this.selectedEntity)&&Cesium.defined(this.selectedEntity.polygon)&&Cesium.defined(this.selectedEntity.polygon.material)){var i=this.selectedEntity.polygon.outlineColor.getValue();this.selectedEntity.polygon.outlineColor=i.withAlpha(e)}},PlacePolygonViewModel.prototype.modifyClassificationType=function(e){Cesium.defined(this.selectedEntity)&&Cesium.defined(this.selectedEntity.polygon)&&(this.selectedEntity.polygon.perPositionHeight=null==e,this.selectedEntity.polygon.classificationType=e)},PlacePolygonViewModel.prototype.Edit=function(e){var t=this;t.selectedEntity=e,layui.use("layer",function(){var e=layui.layer;t._layerIndex=e.open({type:1,skin:"dataEarth-viewer-polygonLayer",area:"303px",shade:0,anim:0,title:" ",resize:!1,offset:["80px","360px"],content:$(t._element),success:function(){t._viewer.layersManager&&(t._viewer.layersManager.viewModel._layersManagerOverLay="block"),t.initialiseHandlers(),t._removeselectedEntityChanged=t._viewer.selectedEntityChanged.addEventListener(function(e){t.selectedEntity=e})},cancel:function(e,i){t._viewer.layersManager&&(t._viewer.layersManager.viewModel._layersManagerOverLay="none"),t.hidden()}})})},PlacePolygonViewModel.prototype.Show=function(){var t=this;layui.use("layer",function(){var e=layui.layer;t._layerIndex=e.open({type:1,skin:"dataEarth-viewer-polygonLayer",area:"262px",shade:0,anim:0,title:" ",resize:!1,offset:["80px","360px"],content:$(t._element),success:function(){t._viewer.layersManager&&(t._viewer.layersManager.viewModel._layersManagerOverLay="block"),t.initialiseHandlers(),t._removeselectedEntityChanged=t._viewer.selectedEntityChanged.addEventListener(function(e){t.selectedEntity=e}),t.startDrawingPolygon()},cancel:function(e,i){t._viewer.layersManager&&(t._viewer.layersManager.viewModel._layersManagerOverLay="none"),t.hidden()}})})},PlacePolygonViewModel.prototype.hidden=function(){Cesium.defined(this._eventHandler)&&0<this._layerIndex&&(layui.layer.close(this._layerIndex),this._eventHandler.destroy(),this.cleanUp(),this.selectedEntity=null,Cesium.defined(this._removeselectedEntityChanged)&&this._removeselectedEntityChanged())},PlacePolygonViewModel.prototype.registerEditableShape=function(i){setListener(i,"mouseMove",function(e){i._editMode}),setListener(i,"mouseOut",function(e){}),setListener(i,"leftClick",function(e){i.setEditMode(!0)}),setListener(i,"leftUp",function(e){}),setListener(i,"leftDown",function(e){})},PlacePolygonViewModel.prototype.cameraControllerChange=function(){this.cameraController=!this.cameraController};