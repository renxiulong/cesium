"use strict";function FlightPath(e,t){var a=document.createElement("div");a.style.display="none",a.classList.add("dataEarth-flightPathLayer"),e.appendChild(a);a.innerHTML='<div ><button data-bind = "click: addPath"   class="addFlightPath">添加飞行路线</button></div>';var i=new FlightPathViewModel(t,$(a));this._viewModel=i,Cesium.knockout.applyBindings(i,a)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var a=[],i=!0,n=!1,r=void 0;try{for(var l,o=e[Symbol.iterator]();!(i=(l=o.next()).done)&&(a.push(l.value),!t||a.length!==t);i=!0);}catch(e){n=!0,r=e}finally{try{i||null==o.return||o.return()}finally{if(n)throw r}}return a}function _arrayWithHoles(e){if(Array.isArray(e))return e}function FlightPathViewModel(e,c){this._viewer=e,this._element=c,this._scene=e.scene,this._visible=!1,this._addViewPort=!0,this._cameraFlyMap=new Map,this._currentViewPointName="",this._currentPathName="",this.uiMap=new Map;var r=this;this.pathClick=function(e){var t=$(e.target).next().next();r._currentPathName=t.data("pathName");var a=t.parents(".pathContainer").find(".path-item").css("display");t.parents(".pathContainer").find(".path-item").css("display","block"===a?"none":"block")},this.getObject=function(e){return this._cameraFlyMap.get(e)},this.deletePath=function(e){this._cameraFlyMap.delete(e)},this.addPath=function(e){var n=this;if(e=e||n,Cesium.defined(e)&&Cesium.defined(e._element))for(var t="path "+(n._cameraFlyMap.size+1),a=1;n._cameraFlyMap.has(t);){t="path "+(n._cameraFlyMap.size+a),a++}else t=e;var r=$('<div class="pathContainer"><div class="path-title"><div class="path-titleText"><i class="flightDown-icon"></i><i class="flightPath-icon"></i><input type="text" class="pathName" value="飞行路径1" readonly=""></div><div class="path-titleButton"><i class="pathPlay" title="飞行"></i><i class="stop" title="停止"></i><i class="addViewPoint" title="添加视点"></i><i class="rename" title="重命名"></i><i class="deletePath" title="删除"></i></div></div></div>'),i=$('<div class="path-item"></div>');r.append(i),n._element.append(r);var l=new cameraFlyObject(n._viewer,n);n._cameraFlyMap.set(t,l),n.uiMap.set(t,r),r.data("pathName",t),$(r.find(".addViewPoint"))[$(r.find(".addViewPoint")).length-1].onclick=function(e){n._currentPathName=$(e.target).parents(".pathContainer").data("pathName"),$(this).prev().prev().removeAttr("disabled"),n.addViewPoint(n._currentPathName)};var o=$(r.find(".pathPlay"))[$(r.find(".pathPlay")).length-1];$(o).data("pathName",t),Cesium.defined(e)&&Cesium.defined(e._element)&&$(o).attr("disabled",!0),o.onclick=this.pathPlay;var s=$(r.find(".stop"))[$(r.find(".stop")).length-1];$(s).data("pathName",t),s.onclick=function(e){n._currentPathName=$(e.target).parents(".pathContainer").data("pathName"),$(e.target).prev()[0].title="飞行",$(e.target).prev()[0].classList.remove("pause"),$(e.target).prev()[0].classList.add("play"),n.getObject(n._currentPathName).stop()},$(r.find(".rename"))[$(r.find(".rename")).length-1].onclick=function(e){var t=$(e.target).parents(".pathContainer").data("pathName");$(n.uiMap.get(t).find(".pathName")[0]).attr("readOnly",!1)},$(r.find(".deletePath"))[$(r.find(".deletePath")).length-1].onclick=function(e){var t=$(e.target).parents(".pathContainer").data("pathName");n.uiMap.get(t).empty(),n.uiMap.delete(t),n.deletePath(t)};var c=$(r.find(".pathName"))[$(r.find(".pathName")).length-1];$(c).data("pathName",t),$(c).data("oldName",t),$(c).data("display",!0),$(c).attr("value",t),c.focus(),$(r).find(".flightDown-icon").on("click",n.pathClick),$(c).blur(function(e){$(e.target).attr("readOnly",!0)}),$(c).bind("input propertychange",function(e){var t=$(e.target).data("pathName"),a=$(e.target).val();if(n._cameraFlyMap.has(a))$(e.target).val(t);else{$(e.target).data("oldName",$(e.target).val()),$(e.target).data("pathName",$(e.target).val()),$(e.target).parents(".pathContainer").data("pathName",$(e.target).val());var i=n._cameraFlyMap.get(t);n._cameraFlyMap.delete(t),n._cameraFlyMap.set(a,i),n._currentPathName=a;n.uiMap.get(t);n.uiMap.delete(t),n.uiMap.set(a,r)}})},this.pathPlay=function(e){r._currentPathName=$(e.target).parents(".pathContainer").data("pathName"),"飞行"===e.target.title?(r.getObject(r._currentPathName).play(),e.target.title="暂停",e.target.classList.remove("play"),e.target.classList.add("pause")):"暂停"===e.target.title&&(r.getObject(r._currentPathName).pause(),e.target.title="飞行",e.target.classList.remove("pause"),e.target.classList.add("play"))},this.loadViewPoint=function(e,i){var n=r._cameraFlyMap.get(i);e.forEach(function(e){n._cameraTrackControls.getAllKeys().push({destination:e.destination,orientation:{direction:e.orientation.direction,up:e.orientation.up},time:e.time,viewPointName:e.viewPointName});var t=$('<div class="viewPointDiv"><input class="viewpointName" readOnly></input></div>');r._cameraFlyMap.set(i,n),t.data("viewpointName",e.viewPointName),r.uiMap.get(i).append(t);var a=$(r.uiMap.get(i).find(".viewpointName"));$(a[a.length-1]).attr("value",e.viewPointName),$(a[a.length-1]).data("viewpointName",e.viewPointName),$(a[a.length-1]).dblclick(function(e){r._currentPathName=$(e.target.parentNode.parentNode).data("pathName"),r._currentViewPointName=$(e.target).val();var t=[].indexOf.call(e.target.parentNode.parentNode.querySelectorAll(e.target.parentNode.tagName),e.target.parentNode);r.getObject(r._currentPathName).viewPointFly(t)})})},this.addViewPoint=function(n,e,t){var r=this,a=r._cameraFlyMap.get(n);if(a){var i;i=Cesium.defined(e)?e:"viewpoint "+(a._cameraTrackControls.getAllKeys().length+1);var l=$('<div class="viewPointDiv"><div class="viewPointDiv-name"><i class="path-itemIcon"></i><input type="text" class="viewpointName" value="视点1" readonly=""></div><div class="viewPointDiv-opt"><span><input type="text" class="playTime" value="1"><label>s</label></span><i class="renameViewPoint" title="重命名"></i><i class="deleteViewPoint" title="删除"></i></div></div>');$(r.uiMap.get(n).find(".path-item")[0]).append(l);var o=$(l).find(".viewpointName");$(o[o.length-1]).attr("value",i),o[o.length-1].focus(),$(o[o.length-1]).dblclick(function(e){r._currentPathName=$(e.target).parents(".pathContainer").data("pathName");var t=[].indexOf.call(e.target.parentNode.parentNode.parentNode.querySelectorAll(".viewPointDiv"),e.target.parentNode.parentNode);r.getObject(r._currentPathName).viewPointFly(t)}),$(o[o.length-1]).blur(function(e){$(e.target).attr("readOnly",!0)}),$(c.find(".renameViewPoint"))[$(c.find(".renameViewPoint")).length-1].onclick=function(e){$($(e.target).parents(".viewPointDiv").find(".viewpointName")[0]).attr("readOnly",!1)},$(c.find(".deleteViewPoint"))[$(c.find(".deleteViewPoint")).length-1].onclick=function(e){var t=[].indexOf.call(e.target.parentNode.parentNode.parentNode.querySelectorAll(".viewPointDiv"),e.target.parentNode.parentNode);e.target.parentNode.parentNode.remove(),r.getObject(r._currentPathName).deleteViewPoint(t)},$(o[o.length-1]).bind("input propertychange",function(e){r._currentPathName=$(e.target).parents(".pathContainer").data("pathName");var t=[].indexOf.call(e.target.parentNode.parentNode.parentNode.querySelectorAll(".viewPointDiv"),e.target.parentNode.parentNode),a=$(e.target).val(),i=r._cameraFlyMap.get(n);i&&i.changeName(t,a)});var s=$(r.uiMap.get(n).find(".playTime"));$(s[s.length-1]).bind("input propertychange",function(e){r._currentPathName=$(e.target).parents(".pathContainer").data("pathName");var t=r.getObject(r._currentPathName),a=$(e.target).val(),i=parseFloat(a),n=[].indexOf.call(e.target.parentNode.parentNode.parentNode.parentNode.querySelectorAll(".viewPointDiv"),e.target.parentNode.parentNode.parentNode);0===n?$(e.target).val(0):0<n&&(t._cameraTrackControls.getAllKeys()[n].time=t._cameraTrackControls.getAllKeys()[n-1].time+1e3*i)}),Cesium.defined(t)?$(s[s.length-1]).val(t.toFixed(2)):r.getObject(n).addViewPoint(i)}}}Cesium.defineProperties(FlightPath.prototype,{viewModel:{get:function(){return this._viewModel}}}),FlightPathViewModel.prototype.load=function(e){if(Cesium.defined(e)){var a=this,t=$("<div ><h4>飞行设置</h4></div>");a._element.append(t);for(var i=1;i<e.length;i++){var n=e[i].name,r=$('<div ><input type="text" class = pathName readOnly></input><button class=pathPlay>飞行</button><button class="stop">停止</button></div>');a._element.append(r),r.data("pathName",n);var l=new cameraFlyObject(a._viewer,a);a._cameraFlyMap.set(n,l);var o=$(r).find(".pathName");$(o[o.length-1]).attr("value",n),$(o[o.length-1]).data("pathName",n),$(o[o.length-1]).data("display",!0),a.uiMap.set(n,r);var s=$(a._element.find(".pathPlay"))[$(a._element.find(".pathPlay")).length-1];$(s).data("pathName",n),s.onclick=a.pathPlay;var c=$(a._element.find(".stop"))[$(a._element.find(".stop")).length-1];$(c).data("pathName",n),c.onclick=function(e){a._currentPathName=$(e.target.parentNode).data("pathName");var t=$(e.target).data("pathName");$(a).prev().text("飞行"),a.getObject(t).stop()},a.loadViewPoint(e[i].viewPoints,n)}}},FlightPathViewModel.prototype.fromJSON=function(e){if(Cesium.defined(e))for(var t=1;t<e.length;t++){var a=e[t].name;this.addPath(a);var i=this.getObject(a),n=0,r=!0,l=!1,o=void 0;try{for(var s,c=e[t].viewPoints[Symbol.iterator]();!(r=(s=c.next()).done);r=!0){var d=s.value;i._cameraTrackControls.getAllKeys().push({destination:d.destination,orientation:{direction:d.orientation.direction,up:d.orientation.up},time:d.time,viewPointName:d.viewPointName}),i._timeDelta=d.time+2e3,this.addViewPoint(a,d.viewPointName,(d.time-n)/1e3),n=d.time}}catch(e){l=!0,o=e}finally{try{r||null==c.return||c.return()}finally{if(l)throw o}}}},FlightPathViewModel.prototype.toJSON=function(){var e=[],t={id:"document",version:"1.0"};e.push(t);var a=!0,i=!1,n=void 0;try{for(var r,l=this._cameraFlyMap[Symbol.iterator]();!(a=(r=l.next()).done);a=!0){var o=_slicedToArray(r.value,2),s=o[0],c=o[1],d={};d.name=s;var h=[];d.viewPoints=h;var p=!0,m=!1,u=void 0;try{for(var v,g=c._cameraTrackControls.getAllKeys()[Symbol.iterator]();!(p=(v=g.next()).done);p=!0){var y=v.value,f={};f.viewPointName=y.viewPointName,f.destination=y.destination;var _={};_.direction=y.orientation.direction,_.up=y.orientation.up,f.orientation=_,f.time=y.time,h.push(f)}}catch(e){m=!0,u=e}finally{try{p||null==g.return||g.return()}finally{if(m)throw u}}e.push(d)}}catch(e){i=!0,n=e}finally{try{a||null==l.return||l.return()}finally{if(i)throw n}}return e};var editerVisible=Cesium.knockout.observable(!0);function cameraFlyObject(p,e){this._viewer=p;var m=this;this._FlightPathViewModel=e,this._timeDelta=0,this._viewPointNameArray=[],m._cameraTrackControls=new Cesium.DECameraTrackControls(p.scene),this._speed=100,this.addViewPoint=function(e){this._viewPointNameArray.push(e);var t,a=Cesium.Cartographic.fromCartesian(this._viewer.scene.camera.position.clone());t=this._cameraTrackControls.getAllKeys().length<1?Cesium.Cartographic.fromCartesian(this._viewer.scene.camera.position.clone()):Cesium.Cartographic.fromCartesian(this._cameraTrackControls.getAllKeys()[this._cameraTrackControls.getAllKeys().length-1].destination);var i=new Cesium.EllipsoidGeodesic;i.setEndPoints(a,t);var n,r=i.surfaceDistance,l=this._viewer._lastWidth,o=this._viewer._lastHeight,s=this._viewer.scene.pickGlobe(new Cesium.Cartesian2(0,o/2)),c=this._viewer.scene.pickGlobe(new Cesium.Cartesian2(l,o/2));if(Cesium.defined(s)&&Cesium.defined(c)){var d=Cesium.Cartesian3.distance(s,c);this._speed=d/4,n=r/this._speed}else n=2,this._speed=r/n;var h=$(this._FlightPathViewModel.uiMap.get(this._FlightPathViewModel._currentPathName)).find(".playTime");$(h[this._cameraTrackControls.getAllKeys().length]).val(n.toFixed(2)),this._timeDelta+=n,this._cameraTrackControls.getAllKeys().push({destination:p.scene.camera.position.clone(),orientation:{direction:p.scene.camera.direction.clone(),up:p.scene.camera.up.clone()},time:1e3*m._timeDelta,viewPointName:e})},this.play=function(){m._cameraTrackControls.play(),m._cameraTrackControls.onComplete(function(){for(var e=$(m._FlightPathViewModel._element).find(".pathPlay"),t=0;t<e.length;t++)if($(e[t].parentNode.parentNode.parentNode).data("pathName")===m._FlightPathViewModel._currentPathName){e[t].title="飞行",e[t].classList.remove("pause"),e[t].classList.add("play");break}})},this.pause=function(){this._cameraTrackControls.pause()},this.changeName=function(e,t){this._viewPointNameArray[e]=t,this._cameraTrackControls.getAllKeys()[e].viewPointName=t},this.stop=function(){this._cameraTrackControls.stop()},this.viewPointFly=function(e){var t=this._cameraTrackControls.getAllKeys()[e];t&&this._cameraTrackControls.camera.flyTo(t)},this.deleteViewPoint=function(e){if(!(this._cameraTrackControls.getAllKeys().length<=e)){if(e<this._cameraTrackControls.getAllKeys().length-1&&0<e){var t=new Cesium.EllipsoidGeodesic,a=Cesium.Cartographic.fromCartesian(this._cameraTrackControls.getAllKeys()[e-1].destination),i=Cesium.Cartographic.fromCartesian(this._cameraTrackControls.getAllKeys()[e+1].destination);t.setEndPoints(a,i);var n=t.surfaceDistance/this._speed;$playTimes=$(this._FlightPathViewModel.uiMap.get(this._FlightPathViewModel._currentPathName)).find(".playTime"),$($playTimes[e]).val(n.toFixed(2)),this._cameraTrackControls.getAllKeys()[e+1].time=this._cameraTrackControls.getAllKeys()[e-1].time+1e3*n}0===e&&0<this._cameraTrackControls.getAllKeys().length&&($playTimes=$(this._FlightPathViewModel.uiMap.get(this._FlightPathViewModel._currentPathName)).find(".playTime"),$($playTimes[0]).val((0).toFixed(2)),this._cameraTrackControls.getAllKeys()[0].time=0),this._cameraTrackControls.getAllKeys().splice(e,1),0===this._cameraTrackControls.getAllKeys().length&&(this._timeDelta=0)}},this.destroy=function(){this._viewPointNameArray=[],this._cameraTrackControls.clear()}}function viewerFlightPathMixin(e){var t=new FlightPath(document.querySelector(".cesium-viewer"),e);Cesium.defineProperties(e,{flightPath:{get:function(){return t}}})}Cesium.defineProperties(FlightPathViewModel.prototype,{scene:{get:function(){return this._scene}},editerVisible:{set:function(e){return editerVisible(e)},get:function(){return editerVisible()}}}),FlightPathViewModel.prototype.Show=function(){var a=this;layui.use("layer",function(){var e=layui.layer;a._layerIndex=e.open({type:1,skin:"dataEarth-viewer-flightPath",area:"362px",shade:0,anim:0,title:" ",resize:!1,offset:["80px","360px"],content:$(a._element),cancel:function(e,t){a.hidden()}})})},FlightPathViewModel.prototype.hidden=function(){0<this._layerIndex&&layui.layer.close(this._layerIndex)},Cesium.defineProperties(cameraFlyObject.prototype,{scene:{get:function(){return this._scene}}});