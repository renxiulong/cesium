"use strict";function ClassificationEditer(e,i){var t=document.createElement("div");e.appendChild(t),t.classList.add("dataEarth-classificationLayer"),t.style.display="none";t.innerHTML=' <dl>    <dt>操作</dt>    <dd class="option" style="padding: 10px 4px;">      <div class="polygonEdit">        <a data-bind="click: editPolygon, css: { current: editType === \'polygon\' }" title="编辑面">绘制面</a>        <a data-bind="click: editPolygonVolume, css: { current: editType === \'volume\' }" title="编辑体">绘制体</a>        <a data-bind="click: editPolygonVolumeBatch, css: { current: editType === \'peices\' }" title="编辑层">分层</a>      </div>    </dd>  </dl>  <dl>    <dt>基础设置</dt>    <dd>      <div class="sliderWrap">        不透明度<span id="invertedAlpha" class="sliderAlpha"></span>      </div>        <div class="checkBox">          <input type="checkbox" id="highLigh" data-bind="checked: invertClassification">           <label for="highLigh" class="lightObj">高亮对象</label>        </div>    </dd>  </dl>  <dl>    <dt>单体管理</dt>    <dd>      <ul id="DataEarth-treeManagerContainer" class="ztree"></ul>      <div data-bind="style : {display : propertyDisplay}">        <div id="propertyTable">          <div style="border: 1px solid #cccccc; height: 20px; line-height: 20px;">            <span style="width: 88px; text-align: center; border-right: 1px solid #cccccc; margin: 0px;" >属性名称</span>            <span style="width: 129px; text-align: center; margin: 0px auto;">属性值</span>          </div>          <ul data-bind="foreach: properties">            <li class="createInp" style="display: flex;line-height: 20px;min-height: 20px;border: 1px solid #cccccc;border-top: none;" data-bind="click: $parent.modifyTableProperties">              <span data-bind="text: itemName" style="width: 88px; text-align: center; border-right: 1px solid #cccccc; margin: 0px;"></span>              <span style="width: 129px; text-align: center; margin: 0px auto;" data-bind="text: itemValue"></span>            </li>          </ul>        </div>        <button style="border: none; background: #169DF9;color:#ffffff; padding: 0 20px; border-radius: 3px;margin-left: 112px;margin-top: 3px;line-height: 20px;height: 20px;text-align: center;" data-bind="click: addProperties">添加属性</button>      </div>    </dd>  </dl>';var n=new ClassificationEditerViewModel(i,t);Cesium.knockout.applyBindings(n,t);var o=document.createElement("div");o.classList.add("dataEarth-classifation-menuWrap");o.innerHTML='<div id="DataEarth-rMneuContainer" >      <ul>        <li id="m_addFolder" data-bind="click: addFolder">新建文件夹</li>        <li id="m_rename" data-bind="click: renameNode">重命名</li>        <li id="m_del" data-bind="click: removeTreeNode">删除</li>      </ul>    </div>',t.appendChild(o),new PerfectScrollbar("#DataEarth-treeManagerContainer"),Cesium.knockout.applyBindings(n._classificationManagerViewModel,o),this._viewModel=n}function ClassificationEditerViewModel(e,i){this._viewer=e,this._element=i;var l=this;e.scene.canvas;this._scene=e.scene,this._layerIndex=0,this._classificationLayer=new Cesium.DEClassificationLayer,this._scene.primitives.add(this._classificationLayer),this._geometryEditer=new ClassificationGeometryEditerViewModel(e,this),this._classificationManagerViewModel=new ClassificationManagerViewModel(e,this),this._scene.invertClassification=!1,this._scene.invertClassificationColor=new Cesium.Color(.25,.25,.25,1),this.editerVisible=!0,this._currentPrimitive=void 0,this.treeEntity=[],this.editType=void 0,Cesium.knockout.track(this,["propertyDisplay","properties","editType"]),this.propertyDisplay="none",this.properties=[];var c=null,t=document.createElement("div");t.classList.add("classification-properties-table");var n=document.createElement("a");n.classList.add("table-close");var o=document.createElement("table");t.appendChild(n),t.appendChild(o);var r=new Cesium.DEHtmlOverlay(l._viewer.scene,t.cloneNode(!0));r.pixelOffset=new Cesium.Cartesian2(-15,18),r.show=!1,r.depthTest=!1,document.querySelector(".table-close").addEventListener("click",function(e){r.show=!1}),e.selectedEntityChanged.addEventListener(function(e){if(e instanceof Cesium.ClassificationPrimitive&&(!l._layerIndex||0===l._layerIndex)&&e.properties&&0<e.properties.length){var i="";e.properties.forEach(function(e){i="\n                ".concat(i,"\n                <tr>\n                   <td>").concat(e.itemName,"</td><td>").concat(e.itemValue,"</td>\n                </tr>")}),r.show=!0,r.position=e.position||e.position._value,r.element.querySelector("table").innerHTML="\n                <thead>\n                    <th>属性</th><th>值</th>\n                </thead>\n                <tbody>\n                    ".concat(i,"\n                </tbody>\n              ")}}),this._liClickEvent=Cesium.createCommand(function(e,i){for(var t=document.getElementsByClassName("DataEarth-viewer-LI"),n=0;n<t.length;n++)t[n].style="background : none; box-shadow : none";if((i.srcElement.style="background: #adf; color: #000; border-color: #fff;box-shadow: 0 0 8px #fff;",c)&&500<(new Date).getTime()-c){if(l.selectedIndex==e.Id){var o=i.srcElement.innerHTML;i.srcElement.style="background : none; box-shadow : none",i.srcElement.innerHTML="<input type='text' value='"+o+"' style='width: 100%;margin-left: -13px; background:default;cursor: default;' onkeydown='keyDown(this)' onblur='myblur(this)'>",l.editInput=!0,l.hasInput=i.srcElement}null!=l.srcElementStyle&&(l.srcElementStyle.style=defaultStatus,l.srcElementStyle=null),l.selectedIndex=e.Id,l.selectedName=e.name,l.selectedDirection=e.direction,l.selectedPitch=e.pitch,l.selectedDistance=e.distance,l.selectedHorizontalFov=e.horizontalFov,l.selectedVerticalFov=e.verticalFov,l.selectedVisibleAreaColor=e.visibleAreaColor,l.selectedHiddenAreaColor=e.hiddenAreaColor;var r=Cesium.Cartographic.fromCartesian(e.viewerPosition),s=Cesium.Math.toDegrees(r.longitude),a=Cesium.Math.toDegrees(r.latitude),d=r.height;l.selectedLongtitude=s,l.selectedLatitude=a,l.selectedHeight=d,l._cancelHight(),e.lineColor=new Cesium.Color(1,1,1,1),l._startAgain=!1,l._drawAgain=!1,i.srcElement.style="background: #adf; color: #000; border-color: #fff;box-shadow: 0 0 8px #fff;",l.srcElementStyle=i.srcElement}e.Id,c=(new Date).getTime()}),this._dbClickEvent=Cesium.createCommand(function(e,i){if(l.selectedIndex==e.Id){var t=i.srcElement.innerHTML;i.srcElement.innerHTML="<input type='text' value='"+t+"' style='width: 100%;margin-left: -13px; background:default;cursor: default;' onkeydown='keyDown(this)' onblur='myblur(this)'>",l.editInput=!0,l.hasInput=i.srcElement}l.editInput&&null!=l.hasInput&&(null!=l.hasInput.childNodes[0].value&&(l.hasInput.innerHTML=l.hasInput.childNodes[0].value),l.editInput=!1)}),this._removePostRenderEvent=e.scene.postRender.addEventListener(function(){});var s=Cesium.knockout.observable();Cesium.knockout.defineProperty(this,"invertClassification",{get:function(){return s()},set:function(e){s(e),Cesium.defined(l._scene)&&(l._scene.invertClassification=e)}}),this.invertClassification=!1;var a=Cesium.knockout.observable();Cesium.knockout.defineProperty(this,"invertedAlpha",{get:function(){return a()},set:function(e){a(e),Cesium.defined(l._scene)&&(l._scene.invertClassificationColor.alpha=parseFloat(e))}}),l.invertedAlpha=.5,layui.use("slider",function(){layui.slider.render({elem:"#invertedAlpha",value:10*l.invertedAlpha,setTips:function(e){return e+"%"},change:function(e){l.invertedAlpha=parseInt(e)/100}})}),this.modifyTableProperties=function(e,t){var n=Cesium.knockout.contextFor(t.currentTarget).$index(),o=e,r=l.properties;if(!o.editable){o.editable=!0,t.currentTarget.innerHTML="";var s=document.createElement("input"),a=document.createElement("input");s.value=o.itemName,a.value=o.itemValue,t.currentTarget.appendChild(s),t.currentTarget.appendChild(a),s.onblur=function(){if(s.value||a.value){o.itemName=s.value,o.editable=!1,r.splice(n,1,o),t.currentTarget.innerHTML="";var e=document.createElement("span");e.innerText=o.itemName;var i=document.createElement("span");i.innerText=o.itemValue,t.currentTarget.appendChild(e),t.currentTarget.appendChild(i)}else t.currentTarget.innerHTML="",r.splice(n,1);l.properties=r,l.updatePropertiesTable()},a.onblur=function(){if(s.value||a.value){o.itemValue=a.value,o.editable=!1,r.splice(n,1,o),t.currentTarget.innerHTML="";var e=document.createElement("span");e.innerText=o.itemName;var i=document.createElement("span");i.innerText=o.itemValue,t.currentTarget.appendChild(e),t.currentTarget.appendChild(i)}else t.currentTarget.innerHTML="",r.splice(n,1);l.properties=r,l.updatePropertiesTable()}}}}var editPolygonVolume,heights;function sortByHeight(e,i){return i-e}Cesium.defineProperties(ClassificationEditer.prototype,{viewModel:{get:function(){return this._viewModel}}}),Cesium.defineProperties(ClassificationEditerViewModel.prototype,{scene:{get:function(){return this._scene}},currentPrimitive:{get:function(){return this._currentPrimitive},set:function(e){if(Cesium.defined(e)){if(Cesium.defined(this._currentPrimitive)&&this._currentPrimitive.id!==e.id)(i=this._currentPrimitive.getGeometryInstanceAttributes(this._currentPrimitive.id)).color=[0,0,0,0],i.show=[1];if(this._currentPrimitive=e,Cesium.defined(this._currentPrimitive)){i=this._currentPrimitive.getGeometryInstanceAttributes(this._currentPrimitive.id);this._scene.invertClassification||(i.color=[255,0,255,128]),i.show=[1],this.updateProperties()}}else{var i;if(Cesium.defined(this._currentPrimitive))(i=this._currentPrimitive.getGeometryInstanceAttributes(this._currentPrimitive.id)).color=[0,0,0,0],i.show=[1],this._currentPrimitive=void 0}}}}),ClassificationEditerViewModel.prototype.initialiseHandlers=function(){var n,o=this._scene,r=this,e=o.canvas;this._eventHandler=new Cesium.ScreenSpaceEventHandler(e),this._eventHandler.setInputAction(function(e){var i=o.pick(e.position);Cesium.defined(i)&&Cesium.defined(i.primitive)&&i.primitive instanceof Cesium.ClassificationPrimitive?r.currentPrimitive=i.primitive:r.currentPrimitive=void 0},Cesium.ScreenSpaceEventType.LEFT_CLICK),this._eventHandler.setInputAction(function(e){if(!Cesium.defined(r.currentPrimitive)){var i=o.pick(e.endPosition);if(Cesium.defined(i)&&Cesium.defined(i.primitive)&&i.primitive instanceof Cesium.ClassificationPrimitive){if(Cesium.defined(n))(t=n.getGeometryInstanceAttributes(n.id)).color=[0,0,0,0],t.show=[1];var t=(n=i.primitive).getGeometryInstanceAttributes(n.id);r._scene.invertClassification||(t.color=[255,0,255,128]),t.show=[1]}else if(Cesium.defined(n)){(t=n.getGeometryInstanceAttributes(n.id)).color=[0,0,0,0],t.show=[1],n=void 0}}},Cesium.ScreenSpaceEventType.MOUSE_MOVE)},ClassificationEditerViewModel.prototype.editPolygon=function(){var r=this;this._geometryEditer.setAction(EditAction.CREATE_POLYGON),this.editType="polygon",this._geometryEditer.onCreatedEvent.removeAllEventListener(),this._geometryEditer.onCreatedEvent.addEventListener(function(e){var i=Cesium.createGuid(),t=e.positions,n=new Cesium.GeometryInstance({geometry:Cesium.PolygonGeometry.fromPositions({positions:t,vertexFormat:Cesium.PerInstanceColorAppearance.VERTEX_FORMAT,extrudedHeight:1e3,perPositionHeight:!1}),attributes:{color:Cesium.ColorGeometryInstanceAttribute.fromColor(new Cesium.Color(1,0,0,0)),show:new Cesium.ShowGeometryInstanceAttribute(!0)},id:i}),o=r._classificationLayer.primitives.add(new Cesium.ClassificationPrimitive({geometryInstances:[n],classificationType:Cesium.ClassificationType.CESIUM_3D_TILE,id:i}));o.name="未命名单体",r._classificationManagerViewModel.updateNode(o),r.editType=void 0})},ClassificationEditerViewModel.prototype.editPolygonVolume=function(){heights=[];var i=this;this.editType="volume",this._geometryEditer._selectedEntity=void 0,this._geometryEditer.setEditType(EditType.NONE),this._geometryEditer.setAction(EditAction.CREATE_POLYGON),this._geometryEditer.onCreatedEvent.removeAllEventListener(),this._geometryEditer.onCreatedEvent.addEventListener(function(e){editPolygonVolume=i._viewer.entities.add({polygon:{hierarchy:{positions:e.positions},material:Cesium.Color.YELLOW.withAlpha(.5),outline:!0,outlineColor:Cesium.Color.BLACK,perPositionHeight:!0,extrudedHeight:1,relativeExtruded:!0}}),i._geometryEditer.selectedEntity=editPolygonVolume,i._geometryEditer.setAction(EditAction.EDIT_GEOMETRY),i._geometryEditer.setEditType(EditType.EA_GEOMETRY_EXTRUDED),i.editType=void 0})},ClassificationEditerViewModel.prototype.editPolygonVolumeBatch=function(){var i=this;this.editType="peices",this._geometryEditer._selectedEntity=void 0,this._geometryEditer.setEditType(EditType.NONE),this._geometryEditer.setAction(EditAction.CREATE_POLYGON),this._geometryEditer.onCreatedEvent.removeAllEventListener(),this._geometryEditer.onCreatedEvent.addEventListener(function(e){editPolygonVolume=i._viewer.entities.add({polygon:{hierarchy:{positions:e.positions},material:Cesium.Color.YELLOW.withAlpha(.5),outline:!0,outlineColor:Cesium.Color.BLACK,perPositionHeight:!0,extrudedHeight:0,relativeExtruded:!0}}),i._geometryEditer.setAction(EditAction.CREATE_POLYLINE),i._geometryEditer.onCreatedEvent.removeAllEventListener(),i._geometryEditer.onCreatedEvent.addEventListener(function(e){heights=e.positions,i.applyPolygonVolume()}),i.editType=void 0})};var cnum=["零","一","二","三","四","五","六","七","八","九"];function rp(e){var i="";e=""+e;for(var t=0;t<e.length;t++)i+=cnum[parseInt(e.charAt(t))];return i}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}ClassificationEditerViewModel.prototype.applyPolygonVolume=function(){if(Cesium.defined(editPolygonVolume)){if(Cesium.defined(heights)&&0<heights.length){u=Cesium.isArray(editPolygonVolume.polygon.hierarchy.getValue())?editPolygonVolume.polygon.hierarchy.getValue():editPolygonVolume.polygon.hierarchy.getValue().positions;for(var e=[],i=0;i<heights.length;i++){var t=heights[i],n=Cesium.Cartographic.fromCartesian(t);e.push(n.height)}e.sort(sortByHeight),e.push(0),0<e.length&&this._classificationManagerViewModel.addFolder();var o=e[0]+3;for(i=1;i<e.length;i++){for(var r=Cesium.createGuid(),s=e[i],a=[],d=0;d<u.length;d++){var l=u[d];(n=Cesium.Cartographic.fromCartesian(l)).height=o,a.push(Cesium.Cartographic.toCartesian(n))}var c=new Cesium.GeometryInstance({geometry:Cesium.PolygonGeometry.fromPositions({positions:a,vertexFormat:Cesium.PerInstanceColorAppearance.VERTEX_FORMAT,extrudedHeight:s-o,perPositionHeight:!0,relativeExtruded:!0}),attributes:{color:Cesium.ColorGeometryInstanceAttribute.fromColor(new Cesium.Color(1,0,0,0)),show:new Cesium.ShowGeometryInstanceAttribute(!0)},id:r});(p=new Cesium.ClassificationPrimitive({geometryInstances:[c],classificationType:Cesium.ClassificationType.CESIUM_3D_TILE,id:r})).name="层"+rp(e.length-i),this._classificationLayer.primitives.add(p),this._classificationManagerViewModel.updateNode(p),o=s}}else{var u;u=Cesium.isArray(editPolygonVolume.polygon.hierarchy.getValue())?editPolygonVolume.polygon.hierarchy.getValue():editPolygonVolume.polygon.hierarchy.getValue().positions;r=Cesium.createGuid();var p,h=new Cesium.GeometryInstance({geometry:Cesium.PolygonGeometry.fromPositions({positions:u,vertexFormat:Cesium.PerInstanceColorAppearance.VERTEX_FORMAT,extrudedHeight:editPolygonVolume.polygon.extrudedHeight,perPositionHeight:!0,relativeExtruded:editPolygonVolume.polygon.relativeExtruded}),attributes:{color:Cesium.ColorGeometryInstanceAttribute.fromColor(new Cesium.Color(1,0,0,0)),show:new Cesium.ShowGeometryInstanceAttribute(!0)},id:r});(p=new Cesium.ClassificationPrimitive({geometryInstances:[h],classificationType:Cesium.ClassificationType.CESIUM_3D_TILE,id:r})).name="未命名对象",this._classificationLayer.primitives.add(p),this._classificationManagerViewModel.updateNode(p)}this._viewer.entities.remove(editPolygonVolume),heights=editPolygonVolume=void 0}},ClassificationEditerViewModel.prototype.updatePropertiesTable=function(){Cesium.defined(this._currentPrimitive)&&Cesium.defined(this.properties)&&(this._currentPrimitive.properties=this.properties)},ClassificationEditerViewModel.prototype.updateProperties=function(){Cesium.defined(this._currentPrimitive)&&(this.properties=this._currentPrimitive.properties||[])},ClassificationEditerViewModel.prototype.addProperties=function(){if(Cesium.defined(this._currentPrimitive)){var e=this.properties;e.push({itemName:"",itemValue:""}),this.properties=e}},ClassificationEditerViewModel.prototype.toJSON=function(){var e=[],i=this._classificationLayer.toJSON();e.push(i);var t=this._classificationManagerViewModel.toJSON();return e.push(t),e},ClassificationEditerViewModel.prototype.fromJSON=function(e){if(Cesium.isArray(e)&&2===e.length){var i=e[0],t=e[1];this._classificationLayer.load(i),this._classificationManagerViewModel.fromJSON(t)}return!1},ClassificationEditerViewModel.prototype.isDestroyed=function(){return!1},ClassificationEditerViewModel.prototype.destroy=function(){return this._eventHandler.destroy(),this._scene.primitives.remove(this._classificationLayer),destroyObject(this)},ClassificationEditerViewModel.prototype.Show=function(){var t=this;layui.use("layer",function(){var e=layui.layer;t._layerIndex=e.open({type:1,skin:"dataEarth-viewer-classification",area:"262px",shade:0,anim:0,title:" ",resize:!1,offset:["80px","360px"],content:$(t._element),success:function(){t.initialiseHandlers(),t._geometryEditer.initialiseHandlers()},cancel:function(e,i){t.hidden()}})})},ClassificationEditerViewModel.prototype.hidden=function(){Cesium.defined(this._eventHandler)&&0<this._layerIndex&&(layui.layer.close(this._layerIndex),this._layerIndex=0,this._eventHandler.destroy(),this._geometryEditer._eventHandler.destroy())};var ellipsoid=Cesium.Ellipsoid.WGS84,EditAction={CREATE_POLYLINE:0,CREATE_POLYGON:1,EDIT_GEOMETRY:2,NONE:5},EditType={EA_HANDLE_MOVE:0,EA_HANDLE_MOVE_Z:1,EA_GEOMETRY_MOVE_Z:2,EA_GEOMETRY_EXTRUDED:3,NONE:5},ChangeablePrimitive=function(){function e(){}return e.prototype.initialiseOptions=function(e){fillOptions(this,e),this._createPrimitive=!0,this._primitive=void 0,this.setStrokeStyle(Cesium.Color.WHITE,2)},e.prototype.setAttribute=function(e,i){this[e]=i,this._createPrimitive=!0},e.prototype.getAttribute=function(e){return this[e]},e.prototype.update=function(e){if(this._createPrimitive||Cesium.defined(this._primitive)){if(this._createPrimitive){var i,t=this.getGeometry();if(!t)return;this._createPrimitive=!1,this._primitive=this._primitive&&this._primitive.destroy(),i=t instanceof Cesium.PolygonGeometry?new Cesium.EllipsoidSurfaceAppearance({aboveGround:!1}):new Cesium.PolylineMaterialAppearance;var n=Cesium.Material.fromType(Cesium.Material.ColorType);if(n.uniforms.color=new Cesium.Color(1,1,0,.5),i.material=n,this._primitive=new Cesium.Primitive({geometryInstances:new Cesium.GeometryInstance({geometry:t,pickPrimitive:this}),appearance:i,asynchronous:!1}),Cesium.defined(this._selectedEntity))switch(this._viewModel._editType){case EditType.EA_GEOMETRY_EXTRUDED:var o=this.positions[0],r=Cesium.Cartographic.fromCartesian(o);if(this._selectedEntity.polygon.relativeExtruded){var s,a=this._selectedEntity.polygon.hierarchy.getValue();s=Cesium.defined(a.positions)?a.positions[0]:a[0];var d=Cesium.Cartographic.fromCartesian(s);this._selectedEntity.polygon.extrudedHeight.setValue(r.height-d.height)}else this._selectedEntity.polygon.extrudedHeight.setValue(r.height);break;default:a=[];for(var l=0;l<this.positions.length;l++)a.push(this.positions[l].clone());this.isPolygon?this._selectedEntity.polygon.hierarchy.setValue(a):this._selectedEntity.polyline.positions.setValue(a)}}var c=this._primitive;c.debugShowBoundingVolume=this.debugShowBoundingVolume,c.update(e)}},e.prototype.isDestroyed=function(){return!1},e.prototype.destroy=function(){return this._primitive=this._primitive&&this._primitive.destroy(),Cesium.destroyObject(this)},e.prototype.setStrokeStyle=function(e,i){this.strokeColor&&this.strokeColor.equals(e)&&this.strokeWidth==i||(this._createPrimitive=!0,this.strokeColor=e,this.strokeWidth=i)},e}(),PolygonPrimitive=function(){function e(e){this.initialiseOptions(e),this.isPolygon=!0,this.isEditPrimitive=!0}return(e.prototype=new ChangeablePrimitive).setPositions=function(e){this.setAttribute("positions",e)},e.prototype.getPositions=function(){return this.getAttribute("positions")},e.prototype.offsetZ=function(e){if(Cesium.defined(this.positions)&&!(this.positions.length<3))for(var i=0;i<this.positions.length;i++){var t=Cesium.Cartographic.fromCartesian(this.positions[i]);t.height+=e,this.positions[i]=Cesium.Cartesian3.fromRadians(t.longitude,t.latitude,t.height)}},e.prototype.getGeometry=function(){if(Cesium.defined(this.positions)&&!(this.positions.length<3)){for(var e=[],i=0;i<this.positions.length;i++)e.push(this.positions[i].clone());return Cesium.PolygonGeometry.fromPositions({positions:e,vertexFormat:Cesium.EllipsoidSurfaceAppearance.VERTEX_FORMAT,ellipsoid:Cesium.Ellipsoid.WGS84,granularity:1e3,perPositionHeight:!0})}},e.prototype.getOutlineGeometry=function(){return Cesium.PolygonOutlineGeometry.fromPositions({positions:this.getPositions(),perPositionHeight:!0})},e}(),PolylinePrimitive=function(){function e(e){this.initialiseOptions(e)}return(e.prototype=new ChangeablePrimitive).setPositions=function(e){this.setAttribute("positions",e)},e.prototype.setWidth=function(e){this.setAttribute("width",e)},e.prototype.setGeodesic=function(e){this.setAttribute("geodesic",e)},e.prototype.getPositions=function(){return this.getAttribute("positions")},e.prototype.getWidth=function(){return this.getAttribute("width")},e.prototype.getGeodesic=function(e){return this.getAttribute("geodesic")},e.prototype.offsetZ=function(e){if(Cesium.defined(this.positions)&&!(this.positions.length<3))for(var i=0;i<this.positions.length;i++){var t=Cesium.Cartographic.fromCartesian(this.positions[i]);t.height+=e,this.positions[i]=Cesium.Cartesian3.fromRadians(t.longitude,t.latitude,t.height)}},e.prototype.getGeometry=function(){if(Cesium.defined(this.positions)&&!(this.positions.length<2)){for(var e=[],i=0;i<this.positions.length;i++)e.push(this.positions[i].clone());return new Cesium.PolylineGeometry({positions:e,width:3,vertexFormat:Cesium.EllipsoidSurfaceAppearance.VERTEX_FORMAT,ellipsoid:this.ellipsoid})}},e}();function ClassificationGeometryEditerViewModel(e,i){this._classificationViewModel=i;var t=e.scene.canvas;this._scene=e.scene,this._canvas=t,this._viewer=e,this._onCreatedEvent=new Cesium.Event,this._editAction=EditAction.NONE,this._editType=EditType.NONE,Cesium.knockout.track(this,["_editAction"]),this.enhancePrimitives()}Cesium.defineProperties(ClassificationGeometryEditerViewModel.prototype,{scene:{get:function(){return this._scene}},onCreatedEvent:{get:function(){return this._onCreatedEvent}},selectedEntity:{get:function(){return this._selectedEntity},set:function(e){if(Cesium.defined(this._selectedEntity)&&Cesium.defined(this._selectedEntity.primitive)&&Cesium.defined(this._selectedEntity.primitive._markers)&&!this._selectedEntity.primitive._editMode&&this.cleanUp(),Cesium.defined(e)&&(this.cleanUp(),this._editType=EditType.EA_HANDLE_MOVE,this._editAction=EditAction.EDIT_GEOMETRY,this._selectedEntity=e,Cesium.defined(e.polygon))){var i=e.polygon.hierarchy.getValue();Cesium.defined(i.positions)||(i={positions:i});var t=new PolygonPrimitive(i);this._scene.primitives.add(t),t.setEditable(),(this._selectedEntity.primitive=t)._selectedEntity=this._selectedEntity,t._viewModel=this}}}}),ClassificationGeometryEditerViewModel.prototype.cleanUp=function(){for(var e=this._scene.primitives,i=e._primitives.length-1;0<i;i--){var t=e._primitives[i];(t.isEditPrimitive||Cesium.defined(t._createPrimitive))&&e.remove(t)}},ClassificationGeometryEditerViewModel.prototype.setAction=function(e){this._editAction=e;switch(e){case EditAction.CREATE_POLYLINE:this._startDrawingPolyline({});break;case EditAction.CREATE_POLYGON:this._startDrawingPolygon({callback:function(e){}})}},ClassificationGeometryEditerViewModel.prototype.setEditType=function(e){switch(this._editType=e,this._editAction=EditAction.EDIT_GEOMETRY,e){case EditType.EA_GEOMETRY_EXTRUDED:if(Cesium.defined(this._selectedEntity)&&Cesium.defined(this._selectedEntity.polygon)){this.cleanUp();var i=this._selectedEntity.polygon.hierarchy.getValue();Cesium.defined(i.positions)||(i={positions:i});for(var t=[],n=0;n<i.positions.length;n++){var o=i.positions[n],r=Cesium.Cartographic.fromCartesian(o);this._selectedEntity.polygon.relativeExtruded?r.height+=this._selectedEntity.polygon.extrudedHeight.getValue():r.height=this._selectedEntity.polygon.extrudedHeight.getValue();var s=Cesium.Cartographic.toCartesian(r);t.push(s)}var a=new PolygonPrimitive({positions:t});Cesium.defined(this._selectedEntity.primitive._markers)&&this._selectedEntity.primitive._markers.remove(),this._scene.primitives.remove(this._selectedEntity.primitive),this._scene.primitives.add(a),a.setEditable(),(this._selectedEntity.primitive=a)._selectedEntity=this._selectedEntity,a._viewModel=this}break;default:if(Cesium.defined(this._selectedEntity)&&Cesium.defined(this._selectedEntity.polygon)){this.cleanUp();i=this._selectedEntity.polygon.hierarchy.getValue();Cesium.defined(i.positions)||(i={positions:i});a=new PolygonPrimitive(i);Cesium.defined(this._selectedEntity.primitive._markers)&&this._selectedEntity.primitive._markers.remove(),this._scene.primitives.remove(this._selectedEntity.primitive),this._scene.primitives.add(a),a.setEditable(),(this._selectedEntity.primitive=a)._selectedEntity=this._selectedEntity,a._viewModel=this}}},ClassificationGeometryEditerViewModel.prototype.isDestroyed=function(){return!1},ClassificationGeometryEditerViewModel.prototype.destroy=function(){return this._eventHandler.destroy(),this._removePostRenderEvent(),destroyObject(this)},ClassificationGeometryEditerViewModel.prototype.initialiseHandlers=function(){var d=this._scene,l=this;this._eventHandler=new Cesium.ScreenSpaceEventHandler(d.canvas);var c,e=this._eventHandler,u=new Cesium.Cartesian2(0,0),p=(new Cesium.Cartesian2(0,0),1);e.setInputAction(function(e){if(l._editAction!=EditAction.NONE&&1!=l._handlersMuted&&Cesium.defined(c)&&(l._editType==EditType.EA_GEOMETRY_MOVE_Z||l._editType==EditType.EA_GEOMETRY_EXTRUDED)){if(0==e.startPosition.y||!Cesium.defined(c.offsetZ))return;var i=e.startPosition.y-e.endPosition.y;c.offsetZ(i*p),c._createPrimitive=!0}},Cesium.ScreenSpaceEventType.MOUSE_MOVE),e.setInputAction(function(e){(Cesium.Cartesian2.clone(e.positions),Cesium.defined(c)||l._editType!=EditType.EA_GEOMETRY_EXTRUDED)||Cesium.Cartesian2.distance(u,e.position)<3&&(l._classificationViewModel.applyPolygonVolume(),l.cleanUp());c=void 0,l._scene.screenSpaceCameraController.enableInputs=!0},Cesium.ScreenSpaceEventType.LEFT_UP),e.setInputAction(function(e){c=null,u=Cesium.Cartesian2.clone(e.position);var i=d.pick(e.position);if(Cesium.defined(i)&&(Cesium.defined(i.id)&&Cesium.defined(i.id.primitive)?c=i.id.primitive:i.primitive&&(c=i.primitive)),l._editAction==EditAction.EDIT_GEOMETRY&&Cesium.defined(c)){l._scene.screenSpaceCameraController.enableInputs=!1;var t=l._scene.pickGlobe(e.position);if(t){var n=new Cesium.BoundingRectangle;n.x=0,n.y=0,n.width=l._scene._context.drawingBufferWidth,n.height=l._scene._context.drawingBufferHeight;var o=Cesium.Cartographic.fromCartesian(t),r=Cesium.Cartographic.fromRadians(o.longitude,o.latitude,0),s=Cesium.DEUtility.project(t,l._scene.camera,n),a=Cesium.DEUtility.project(Cesium.Cartographic.toCartesian(r),l._scene.camera,n);p=o.height/(s.y-a.y)}}},Cesium.ScreenSpaceEventType.LEFT_DOWN)},ClassificationGeometryEditerViewModel.prototype.setListener=function(e,i,t){e[i]=t},ClassificationGeometryEditerViewModel.prototype.muteHandlers=function(e){this._handlersMuted=e},ClassificationGeometryEditerViewModel.prototype.startDrawing=function(e){this.disableAllEditMode(),this.editCleanUp&&this.editCleanUp(),this.editCleanUp=e,this.muteHandlers(!0)},ClassificationGeometryEditerViewModel.prototype.stopDrawing=function(){this.editCleanUp&&(this.editCleanUp(),this.editCleanUp=null),this.muteHandlers(!1)},ClassificationGeometryEditerViewModel.prototype.disableAllEditMode=function(){this.setEdited(void 0)},ClassificationGeometryEditerViewModel.prototype.setEdited=function(e){this._editedSurface&&!this._editedSurface.isDestroyed()&&this._editedSurface.setEditMode(!1),this._editedSurface=e};var BillboardGroup=function(e,i){this._viewModel=e,this._scene=e._scene,this._options={iconUrl:"".concat(e._viewer._basePath,"/Plugins/assets/dragIcon.png"),shiftX:0,shiftY:0};var t=new Cesium.BillboardCollection;t.isEditPrimitive=!0,this._scene.primitives.add(t),this._billboards=t,this._orderedBillboards=[]};function clone(e,i){if(null==e||"object"!=_typeof(e))return e;if(e.constructor!=Object&&e.constructor!=Array)return e;if(e.constructor==Date||e.constructor==RegExp||e.constructor==Function||e.constructor==String||e.constructor==Number||e.constructor==Boolean)return new e.constructor(e);for(var t in i=i||new e.constructor,e)i[t]=void 0===i[t]?clone(e[t],null):i[t];return i}function fillOptions(e,i){var t;for(t in e=e||{},i)void 0===e[t]&&(e[t]=clone(i[t]))}BillboardGroup.prototype.createBillboard=function(e,i){var t=this._billboards.add({show:!0,position:e,pixelOffset:new Cesium.Cartesian2(this._options.shiftX,this._options.shiftY),eyeOffset:new Cesium.Cartesian3(0,0,0),horizontalOrigin:Cesium.HorizontalOrigin.CENTER,verticalOrigin:Cesium.VerticalOrigin.CENTER,scale:1.2,image:this._options.iconUrl});return this._viewModel._editAction==EditAction.EDIT_GEOMETRY&&(t.disableDepthTestDistance=1e4,this._billboards._depthMask=!0),t},BillboardGroup.prototype.insertBillboard=function(e,i,t){this._orderedBillboards.splice(e,0,this.createBillboard(i,t))},BillboardGroup.prototype.addBillboard=function(e,i){this._orderedBillboards.push(this.createBillboard(e,i))},BillboardGroup.prototype.addBillboards=function(e,i){for(var t=0;t<e.length;t++)this.addBillboard(e[t],i)},BillboardGroup.prototype.updateBillboardsPositions=function(e){for(var i=0;i<e.length;i++)this.getBillboard(i).position=e[i]},BillboardGroup.prototype.countBillboards=function(){return this._orderedBillboards.length},BillboardGroup.prototype.getBillboard=function(e){return this._orderedBillboards[e]},BillboardGroup.prototype.removeBillboard=function(e){this._billboards.remove(this.getBillboard(e)),this._orderedBillboards.splice(e,1)},BillboardGroup.prototype.remove=function(){this._scene.primitives.remove(this._billboards)},BillboardGroup.prototype.setOnTop=function(){this._scene.primitives.raiseToTop(this._billboards)},ClassificationGeometryEditerViewModel.prototype.startDrawingPolygon=function(){this.setAction(EditAction.CREATE_POLYGON)},ClassificationGeometryEditerViewModel.prototype._startDrawingPolygon=function(e){this.startDrawingPolyshape(!0,e)},ClassificationGeometryEditerViewModel.prototype.startDrawingPolyline=function(){this.setAction(EditAction.CREATE_POLYLINE)},ClassificationGeometryEditerViewModel.prototype._startDrawingPolyline=function(e){this.startDrawingPolyshape(!1,e)},ClassificationGeometryEditerViewModel.prototype.startDrawingPolyshape=function(e,i){this.startDrawing(function(){n.remove(r),l.remove(),o.destroy()});var r,t=this,s=this._scene,n=s.primitives,a=e?3:2;(r=e?new PolygonPrimitive(i):new PolylinePrimitive(i)).asynchronous=!1,n.add(r);var d=[],l=new BillboardGroup(this,{iconUrl:"".concat(t._viewer._basePath,"/Plugins/assets/dragIcon.png"),shiftX:0,shiftY:0}),o=new Cesium.ScreenSpaceEventHandler(s.canvas);o.setInputAction(function(e){if(null!=e.position){var i=s.pickGlobe(e.position);if(i){if(0==d.length&&(d.push(i.clone()),l.addBillboard(d[0])),d.length>=a){for(var t=[],n=0;n<d.length;n++)t.push(d[n].clone());r.positions=t,r._createPrimitive=!0}d.push(i.clone()),l.addBillboard(i.clone())}}},Cesium.ScreenSpaceEventType.LEFT_CLICK),o.setInputAction(function(e){var i=e.endPosition;if(null!=i)if(0==d.length);else{var t=s.pickGlobe(i);if(t){if(d.pop(),d.push(t.clone()),d.length>=a){for(var n=[],o=0;o<d.length;o++)n.push(d[o].clone());r.positions=n,r._createPrimitive=!0}Cesium.defined(l.getBillboard(d.length-1))&&(l.getBillboard(d.length-1).position=t.clone())}}},Cesium.ScreenSpaceEventType.MOUSE_MOVE),o.setInputAction(function(e){var i=e.position;if(null!=i){if(d.length<2+a)return;s.pickGlobe(i)&&(t.stopDrawing(),d.splice(d.length-2,2),t._onCreatedEvent.raiseEvent({positions:d}))}},Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK),o.setInputAction(function(e){t.stopDrawing(),d.splice(d.length-1,1),t._onCreatedEvent.raiseEvent({positions:d})},Cesium.ScreenSpaceEventType.RIGHT_CLICK)},ClassificationGeometryEditerViewModel.prototype.enhancePrimitives=function(){var e=this;PolylinePrimitive.prototype.setEditable=function(){if(!this.setEditMode){this.isPolygon=!1,this.asynchronous=!1}},PolygonPrimitive.prototype.setEditable=function(){this.asynchronous=!1;e._scene}};var folder="http://airlook.oss-cn-beijing.aliyuncs.com/website/folder.svg",file="http://airlook.oss-cn-beijing.aliyuncs.com/website/layer.svg";function ClassificationManagerViewModel(o,e){this._viewModel=e,this._classificationLayer=e._classificationLayer;var a,d=this,t={data:{keep:{leaf:!0,parent:!0}},edit:{enable:!0,showRemoveBtn:!1,showRenameBtn:!1,drag:{isCopy:!1,isMove:!0,prev:!0,inner:!0,next:!0}},callback:{onRightClick:function(e,i,t){{if(!t&&"button"!=e.target.tagName.toLowerCase()&&0==$(e.target).parents("a").length)return;a.selectNode(t)}"root"===t.id?r("root",e.clientX,e.clientY):"folder"===t.id?r("folder",e.clientX,e.clientY):r("node",e.clientX,e.clientY)},beforeRename:function(e,i,t,n){if(0==t.length)return setTimeout(function(){a.cancelEditName(),alert("节点名称不能为空.")},0),!1;for(var o=a.getNodesByFilter(u,!1,i.getParentNode(),i),r=0;r<o.length;r++)if(o[r].name===t&&i.name!==t)return a.cancelEditName(),alert("同一层级不能有相同名称！"),!1;if(Cesium.defined(i.id)){var s=d._classificationLayer.primitives.getById(i.id);Cesium.defined(s)&&(s.name=t,d._viewModel.currentPrimitive=s)}return!0},onClick:function(e,i,t,n){if(Cesium.defined(t.id)&&!t.isParent){var o=d._classificationLayer.primitives.getById(t.id);d._viewModel.currentPrimitive=o,d._viewModel.propertyDisplay="block"}else d._viewModel.currentPrimitive=void 0,d._viewModel.propertyDisplay="none"},onDblClick:function(e,i,t){if(Cesium.defined(t.id)&&!t.isParent){var n=d._classificationLayer.primitives.getById(t.id);o.camera.flyToBoundingSphere(n._primitive._boundingSphereWC[0])}},beforeDrag:function(e,i){for(var t=0,n=i.length;t<n;t++)if(!1===i[t].drag)return!1;return!0},beforeDrop:function(e,i,t,n){},beforeDragOpen:function(e,i){}}},n=[{id:"root",name:"单体对象图层",open:!0,drag:!1,children:[]}];function r(e,i,t){switch($("#DataEarth-rMneuContainer ul li").show(),e){case"root":$("#m_rename").hide(),$("#m_del").hide();break;case"folder":break;case"node":$("#m_addFolder").hide()}t+=document.body.scrollTop,i+=document.body.scrollLeft;var n=$(".dataEarth-classificationLayer").offset();$(".dataEarth-classifation-menuWrap").css({top:t-n.top+"px",left:i-n.left+"px",display:"block"}),$("body").bind("mousedown",s)}function s(e){"DataEarth-rMneuContainer"==e.target.id||0<$(e.target).parents("#DataEarth-rMneuContainer").length||$(".dataEarth-classifation-menuWrap").css({display:"none"})}function l(){$(".dataEarth-classifation-menuWrap").css({display:"none"}),$("body").unbind("mousedown",s)}function c(e,i){if(i.children&&0<i.children.length)for(var t=i.children.length-1;0<=t;t--){c(e,i.children[t])}else{var n=d._classificationLayer.primitives.getById(i.id);Cesium.defined(n)&&(Cesium.defined(d._viewModel.currentPrimitive)&&d._viewModel.currentPrimitive.id===i.id&&(d._viewModel.currentPrimitive=void 0),d._classificationLayer.primitives.remove(n),d._viewModel.propertyDisplay="none"),e.removeNode(i)}}function u(e,i){return e.level===i.level}this.removeTreeNode=function(){l();var e=a.getSelectedNodes();if(e&&0<e.length){if(e[0].children&&0<e[0].children.length){!0===confirm("要删除的节点是父节点，如果删除将连同子节点一起删掉。\n\n请确认！")&&c(a,e[0])}else c(a,e[0]);a.removeNode(e[0])}},this.renameNode=function(){l();var e=a.getSelectedNodes();a.editName(e[0])},this.addFolder=function(){l();var e={name:"新建文件夹",isParent:!0,id:"folder"};if(a.getSelectedNodes()[0]){var i=a.getSelectedNodes()[0];i&&Cesium.defined(i.children)&&0<i.children.length&&i.children.length+1;var t=a.addNodes(a.getSelectedNodes()[0],1,e);a.selectNode(t)}else{var n=a.getNodeByParam("id","root");n.children&&0<n.children.length&&n.children.length+1;t=a.addNodes(n,1,e);console.log(t),a.selectNode(t)}},this.getAllNodes=function(){return a.getNodes()},this.initTree=function(e){$.fn.zTree.init($("#DataEarth-treeManagerContainer"),t,e)},$(document).ready(function(){a||($.fn.zTree.init($("#DataEarth-treeManagerContainer"),t,n),a=$.fn.zTree.getZTreeObj("DataEarth-treeManagerContainer"))});var p,i=Cesium.knockout.observable("block");function h(e,i){if(i.children&&0<i.children.length){for(var t={id:i.id,name:i.name},n=[],o=0;o<i.children.length;o++){var r=i.children[o];n.push(h(e,r))}return t.children=n,t}return t={id:i.id,name:i.name}}Cesium.defineProperties(this,{rightMenuVisiable:{get:function(){return i()},set:function(e){i(e)}}}),ClassificationManagerViewModel.prototype.updateNode=function(e){var i={id:e.geometryInstances[0].id,name:e.name},t=a.getNodeByParam("id","root"),n=(t.getCheckStatus(),a.getSelectedNodes()[0]);Cesium.defined(n)||(n=t),Cesium.isArray(n)&&0<n.length&&(n=n[0]);var o=0;"root"!==n.id&&"folder"!==n.id?(o=n.getIndex()+1,n=n.getParentNode()):o=Cesium.defined(n.children)?n.children.length:0,a.addNodes(n,o,i)},ClassificationManagerViewModel.prototype.toJSON=function(){for(var e=a.getNodeByParam("id","root"),i=[{id:"root",name:"单体对象图层",open:!0,drag:!1}],t=[],n=0;n<e.children.length;n++){var o=e.children[n];t.push(h(a,o))}return i[0].children=t,i},ClassificationManagerViewModel.prototype.fromJSON=function(e){if(Cesium.defined(e[0].children)){$.fn.zTree.init($("#DataEarth-treeManagerContainer"),t,n);var i=(a=$.fn.zTree.getZTreeObj("DataEarth-treeManagerContainer")).getNodeByParam("id","root");Cesium.defined(p)||(p=i),Cesium.isArray(p)&&0<p.length&&(p=p[0]),function e(i,t){if("folder"===t.id){var n={name:t.name,isParent:!0,id:"folder"};p=i.addNodes(p,t.index,n),Cesium.isArray(p)&&0<p.length&&(p=p[0])}if(t.children&&0<t.children.length)for(var o=0;o<t.children.length;o++){var r=t.children[o];r.index=o,e(i,r)}else n={id:t.id,name:t.name},i.addNodes(p,t.index,n)}(a,e[0])}}}function viewerClassificationEditerMixin(e){var i=new ClassificationEditer(document.querySelector(".cesium-viewer"),e);Cesium.defineProperties(e,{classificationEditer:{get:function(){return i}}})}