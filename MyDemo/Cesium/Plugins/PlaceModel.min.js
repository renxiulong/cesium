"use strict";function PlaceModel(e,i){var t=document.createElement("div");e.append(t),t.classList.add("dataEarth-modelLayer"),t.style.display="none";t.innerHTML='<dl>      <dt>名称</dt>      <dd>        <input class="elementName" data-bind="value: modelName, event: { input: updateModelName}, valueUpdate: \'input\'">      </dd>    </dl>    <dl>      <dt>图标</dt>      <dd class="elementModel" data-bind="foreach: modelArray">       <a data-bind="css: {current: $parent._currentModelPath === dataView}, click: $parent.selectCurrentModel"><img data-bind="attr: { src:  dataCoverUrl}"/></a>      </dd>    </dl>    <dl>      <dt>位置</dt>      <dd>        <div class="elementSite">经度          <input type="text" data-bind="value: placeLongitude, event: { input: updatePosition}, valueUpdate: \'input\'">        </div>        <div class="elementSite">纬度          <input type="text" data-bind="value: placeLatitude, event: { input: updatePosition}, valueUpdate: \'input\'">        </div>        <div class="elementHeight">高度          <select data-bind="options:heightOptions, optionsText: \'text\', optionsValue: \'value\', value:heightReference">            <option value="0">绝对高度</option>            <option value="2">相对高度</option>            <option value="1">依地高度</option>          </select>          <input type="number" data-bind="value: height, event: { input: updatePosition}, valueUpdate: \'input\', enable: heightReference !== Cesium.HeightReference.CLAMP_TO_GROUND"> </div>      </dd>    </dl>    <dl>      <dl>        <dt>操作</dt>        <dd>          <div>旋转            <span>              <input type="number" data-bind="value: xAxisRotation, event: {input: updateAxisRotation}, valueUpdate: \'input\'">              <label>°X</label>            </span>            <span>              <input type="number" data-bind="value: yAxisRotation, event: {input: updateAxisRotation}, valueUpdate: \'input\'">              <label>°Y</label>            </span>            <span>              <input type="number" data-bind="value: zAxisRotation, event: {input: updateAxisRotation}, valueUpdate: \'input\'">              <label>°Z</label>            </span>          </div>          <div class="sliderWrap">缩放            <span>              <input type="number" data-bind="value: axisScale, event: {input: updateAxisScale}, valueUpdate: \'input\'">            </span>          </div>        </dd>      </dl>    </dl>';var a=new PlaceModelViewModel(i,t);this._viewModel=a,Cesium.knockout.applyBindings(a,t)}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Cesium.defineProperties(PlaceModel.prototype,{viewModel:{get:function(){return this._viewModel}}});var modelListLayer,EditModelType={EMT_HANDLE_MOVE_XY:0,NONE:1,EMT_HANDLE_SELECTED:2},initEditModelName="未命名模型",boxEntity=[];function PlaceModelViewModel(e,i){this._viewer=e,this._scene=e.scene,this._element=i,this._drawing=!1,this._EditType=EditModelType.NONE,this._EditTypeTemp=EditModelType.NONE,this._EditModel=void 0,this._primitive=void 0,this._eventHandler=void 0,this._ellipsoid=Cesium.Ellipsoid.WGS84,this._isSelected=EditModelType.NONE,this.onCreatedEvent=new Cesium.Event,this.xAxisRotation=0,this.yAxisRotation=0,this.zAxisRotation=0,this.axisScale=1,this.heightReference=Cesium.HeightReference.NONE,this.height=0,this._startEdit=!1,this._currentModelPath="",this.modelName=initEditModelName,this.placeLongitude="0.000",this.placeLatitude="0.000",this.showSelection=!0,this.modelArray=[],this._canMove=!1,this._canDrawing=!0,this.heightOptions=[{text:"绝对高度",value:Cesium.HeightReference.NONE},{text:"相对高度",value:Cesium.HeightReference.RELATIVE_TO_GROUND},{text:"依地高度",value:Cesium.HeightReference.CLAMP_TO_GROUND}],Cesium.knockout.track(this,["modelName","placeLongitude","placeLatitude","xAxisRotation","yAxisRotation","zAxisRotation","height","axisScale","showSelection","heightReference","modelArray","_currentModelPath"]);var t=this;this.selectCurrentModel=function(){t._startEdit=!0,t._drawing=!0,t._currentModelPath=this.dataView,t.updateBilbordIcon(this.dataView),$(".publicModel")[0]&&($(".publicModel").each(function(){$(this).removeClass("current")}),$(".customModel-list")[0]&&$(".customModel-list").each(function(){$(this).removeClass("current")}))}}function removeAddBox(e){for(var i=boxEntity.length,t=0;t<i;t++)e._viewer.entities.removeById(boxEntity[t].id);boxEntity=[]}function addMoveBigBox(t){var e=t._viewer.entities.add({position:new Cesium.CallbackProperty(function(){if(Cesium.defined(t._primitive)&&Cesium.defined(t._primitive.boundingSphere)){var e=CalculateGLTFOrientation(t);return Cesium.Cartesian3.fromDegrees(e[0],e[1],e[2])}},!1),orientation:new Cesium.CallbackProperty(function(){return t._primitive.id.orientation.getValue()},!1),name:"mainBox",box:{dimensions:new Cesium.CallbackProperty(function(){if(Cesium.defined(t._primitive)&&Cesium.defined(t._primitive._boundingSphere)){var e=t._primitive._boundingSphere.clone(),i=t._primitive.modelMatrix.clone();return Cesium.BoundingSphere.transform(e,i,e),new Cesium.Cartesian3(2*e.radius*t._primitive.scale,2*e.radius*t._primitive.scale,2*e.radius*t._primitive.scale)}},!1),material:Cesium.Color.WHITE.withAlpha(.3),outline:!0,outlineColor:Cesium.Color.WHITE}});return boxEntity.push(e),e}function CalculateGLTFOrientation(e){var i=[],t=new Cesium.Cartesian3;t.x=e._primitive.id.position._value.x,t.y=e._primitive.id.position._value.y,t.z=e._primitive.id.position._value.z;var a=Cesium.Cartographic.fromCartesian(t),o=Cesium.Math.toDegrees(a.longitude);i.push(o);var n=Cesium.Math.toDegrees(a.latitude);i.push(n);var d=e._primitive._boundingSphere.clone(),r=e._primitive.modelMatrix.clone();Cesium.BoundingSphere.transform(d,r,d);var l=Cesium.Cartographic.fromCartesian(d.center).height;return i.push(l),i.push(1.5*d.radius*e._primitive.scale),i}function gethpr(e){var i=Cesium.Transforms.eastNorthUpToFixedFrame(e._EditModel.position.getValue(),void 0,new Cesium.Matrix4),t=Cesium.Matrix4.getRotation(Cesium.Matrix4.inverse(i,new Cesium.Matrix4),new Cesium.Matrix3),a=Cesium.Quaternion.fromRotationMatrix(t),o=new Cesium.Quaternion;return Cesium.Quaternion.multiply(a,e._EditModel.orientation.getValue(),o),Cesium.HeadingPitchRoll.fromQuaternion(o)}function getPublicModel(e,i,t){$.ajax({url:"/api/data/public/list",data:{pageNum:e,pageSize:i,dataType:3},success:function(e){t(e.data)}})}function getCustomModel(e,i,t){$.ajax({url:"/api/data/service/list",data:{pageNum:e,pageSize:i,dataServiceTypes:3,dataServiceStatus:1},success:function(e){t(e.data)}})}function viewerPlaceModelMixin(e){var i=new PlaceModel(document.querySelector(".cesium-viewer"),e);Cesium.defineProperties(e,{placeModel:{get:function(){return i}}})}PlaceModelViewModel.prototype.cleanUp=function(){for(var e=this._scene.primitives,i=e._primitives.length-1;0<i;i--){var t=e._primitives[i];t.isEditPrimitive&&e.remove(t)}},PlaceModelViewModel.prototype.initialiseHandlers=function(){var p=this;this._eventHandler=new Cesium.ScreenSpaceEventHandler(p._viewer.scene.canvas);var e=this._eventHandler;e.setInputAction(function(e){if(p._drawing){var i=p._viewer.scene.pickGlobe(e.position);if(null==i)return;var t,a=Cesium.Cartographic.fromCartesian(i),o=Cesium.Math.toDegrees(a.longitude),n=Cesium.Math.toDegrees(a.latitude);t=0<=a.height?i.clone():new Cesium.Cartesian3.fromDegrees(o,n,0),p.modelName=initEditModelName;var d=new Cesium.HeadingPitchRoll(0,0,0),r=Cesium.Transforms.headingPitchRollQuaternion(t,d);p._currentModelPath.includes("test.dataearth.airlook.com")&&(p._currentModelPath=p._currentModelPath.replace("test.dataearth.airlook.com",location.host)),p._EditModel=p._viewer.entities.add({name:p.modelName,position:t,xRotation:0,yRotation:0,zRotation:0,orientation:r,model:{uri:p._currentModelPath,scale:1,heightReference:p.heightReference}}),"undefined"!=typeof ACTION&&p.onCreatedEvent.raiseEvent({action:ACTION.CREATE,type:CONSTANT.DE_Model,value:p._EditModel}),p._viewer.flyTo(p._EditModel),p.position=t;var l=function(){var e=p._EditModel.entityCollection.owner._visualizers[3]._modelHash;Cesium.defined(e[p._EditModel.id].modelPrimitive._boundingSphere)&&(p._viewer.clock.onTick.removeEventListener(l),p._primitive=e[p._EditModel.id].modelPrimitive,removeAddBox(p),addMoveBigBox(p))};p._viewer.clock.onTick.addEventListener(l),p.modelName=p._EditModel.name,p.placeLongitude=o.toFixed(6),p.placeLatitude=n.toFixed(6),p.height=a.height.toFixed(6),p.xAxisRotation=0,p.yAxisRotation=0,p.zAxisRotation=0,p.axisScale=1,p.heightReference=Cesium.HeightReference.NONE,p.LaterallyTranslate(EditModelType.EMT_HANDLE_MOVE_XY)}},Cesium.ScreenSpaceEventType.LEFT_CLICK);var t=function(e,i){e._viewer.scene._screenSpaceCameraController.enableInputs=!1,e._EditType==EditModelType.EMT_HANDLE_MOVE_XY&&(e._EditTypeTemp=EditModelType.EMT_HANDLE_MOVE_XY,e._isSelected=!0),function(e){var i=Cesium.Cartesian3.magnitude(e),t=new Cesium.Cartesian3;t.x=t.y=t.z=i;var a=new Cesium.Ellipsoid;p._ellipsoid=Cesium.Ellipsoid.fromCartesian3(t,a)}(e._viewer.scene.pickPosition(i.position));var t=new Cesium.Cartesian3;if(t=Cesium.Cartographic.fromCartesian(e._EditModel.position.getValue()),e.placeLongitude=Cesium.Math.toDegrees(t.longitude).toFixed(6),e.placeLatitude=Cesium.Math.toDegrees(t.latitude).toFixed(6),e.height=t.height.toFixed(6),e.axisScale=e._EditModel.model.scale.getValue(),e.modelName=e._EditModel.name,e.heightReference=e._EditModel.model.heightReference,Cesium.defined(e._EditModel.xAxisRotation))e.xAxisRotation=e._EditModel.xRotation.toFixed(6),e.yAxisRotation=e._EditModel.yRotation.toFixed(6),e.zAxisRotation=e._EditModel.zRotation.toFixed(6);else if(Cesium.defined(e._EditModel.orientation)){var a=gethpr(e);e.xAxisRotation=Cesium.Math.toDegrees(a.roll).toFixed(6),e.yAxisRotation=Cesium.Math.toDegrees(a.pitch).toFixed(6),e.zAxisRotation=Cesium.Math.toDegrees(a.heading).toFixed(6)}else e.xAxisRotation=0,e.yAxisRotation=0,e.zAxisRotation=0};PlaceModelViewModel.prototype.getMatrix=function(e){var i=e.x*e.x,t=e.y*e.y,a=e.z*e.z,o=e.x*e.y,n=e.x*e.z,d=e.y*e.z,r=e.w*e.x,l=e.w*e.y,s=e.w*e.z,u=[1-2*(t+a),2*(o-s),2*(n+l),0,2*(o+s),1-2*(i+a),2*(d-r),0,2*(n-l),2*(d+r),1-2*(i+t),0,0,0,0,1];return Cesium.Matrix4.fromRowMajorArray(u)},e.setInputAction(function(e){p._EditType!=EditModelType.EMT_HANDLE_MOVE_XY&&p._EditType!=EditModelType.EMT_HANDLE_MOVE_Z||(p._drawing=!1,p._canDrawing=!1,removeAddBox(p))},Cesium.ScreenSpaceEventType.RIGHT_DOWN),e.setInputAction(function(e){if(p._EditType==EditModelType.EMT_HANDLE_MOVE_XY||p._EditType==EditModelType.EMT_HANDLE_MOVE_Z){var i=p._viewer.scene.pick(e.position);Cesium.defined(i)&&(p._canMove=!0,Cesium.defined(i.id)&&("mainBox"==i.id.name||(p._EditModel=i.id,p._primitive=i.primitive,removeAddBox(p)),t(p,e)))}},Cesium.ScreenSpaceEventType.LEFT_DOWN),e.setInputAction(function(e){p._EditTypeTemp===EditModelType.NONE?(p._startEdit&&p._canDrawing&&(p._drawing=!0),p._EditTypeTemp=EditModelType.NONE,p._viewer.scene._screenSpaceCameraController.enableInputs=!0):!0===p._isSelected&&(p._drawing=!1,boxEntity.length<1&&addMoveBigBox(p),p._canDrawing&&(p._startEdit=!0),p._EditTypeTemp=EditModelType.NONE,p._viewer.scene._screenSpaceCameraController.enableInputs=!0)},Cesium.ScreenSpaceEventType.LEFT_UP),e.setInputAction(function(e){if(p._EditTypeTemp!=EditModelType.NONE&&p._EditTypeTemp==EditModelType.EMT_HANDLE_MOVE_XY&&Cesium.defined(p._EditModel)&&Cesium.defined(p._EditModel.position)){boxEntity.length<1&&addMoveBigBox(p);var i=function(e,i){var t=p._ellipsoid.cartesianToCartographic(e),a=Cesium.Math.toDegrees(t.longitude),o=Cesium.Math.toDegrees(t.latitude),n=p._ellipsoid.cartesianToCartographic(i),d=Cesium.Math.toDegrees(n.longitude)-a,r=Cesium.Math.toDegrees(n.latitude)-o,l=Cesium.Cartographic.fromCartesian(p._EditModel.position.getValue()),s=Cesium.Math.toDegrees(l.longitude)+d,u=Cesium.Math.toDegrees(l.latitude)+r,c=[];return c.push(s),c.push(u),c}(p._viewer.camera.pickEllipsoid(e.startPosition,p._ellipsoid),p._viewer.camera.pickEllipsoid(e.endPosition,p._ellipsoid)),t=Cesium.Cartographic.fromCartesian(p._EditModel.position.getValue()),a=Cesium.Cartographic.fromDegrees(i[0],i[1],t.height),o=new Cesium.Cartesian3;Cesium.Cartographic.toCartesian(a,void 0,o),p._EditModel.position=o,p.placeLongitude=Cesium.Math.toDegrees(a.longitude).toFixed(6),p.placeLatitude=Cesium.Math.toDegrees(a.latitude).toFixed(6)}},Cesium.ScreenSpaceEventType.MOUSE_MOVE)},PlaceModelViewModel.prototype.Start=function(){this._drawing=!0,this._startEdit=!0},PlaceModelViewModel.prototype.End=function(){var e=this;e._drawing=!1,e._startEdit=!1,e._EditType=EditModelType.NONE,e._isSelected=EditModelType.NONE,e._EditModel=void 0,e._primitive=void 0,e._ellipsoid=void 0},PlaceModelViewModel.prototype.LaterallyTranslate=function(e){this._EditType=e},PlaceModelViewModel.prototype.updateHeightReference=function(){Cesium.defined(this._EditModel)&&(this._EditModel.model.heightReference=this.heightReference)},PlaceModelViewModel.prototype.updatePosition=function(){if(Cesium.defined(this._EditModel)){var e=new Cesium.Cartesian3.fromDegrees(Number(this.placeLongitude),Number(this.placeLatitude),Number(this.height));this._EditModel.position=e}},PlaceModelViewModel.prototype.updateModelName=function(){var e=this;Cesium.defined(e._EditModel)&&(e._EditModel.name=e.modelName,void 0!==("undefined"==typeof ACTION?"undefined":_typeof(ACTION))&&e.onCreatedEvent.raiseEvent({action:ACTION.UPDATA,type:CONSTANT.DE_Model,value:e._EditModel}))},PlaceModelViewModel.prototype.updateAxisRotation=function(){var e=this;if(Cesium.defined(e._EditModel)){var i=new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(Number(e.zAxisRotation)),Cesium.Math.toRadians(Number(e.yAxisRotation)),Cesium.Math.toRadians(Number(e.xAxisRotation))),t=Cesium.Transforms.headingPitchRollQuaternion(e._EditModel.position.getValue(),i);e._EditModel.orientation=t,e._EditModel.xRotation=Number(e.xAxisRotation),e._EditModel.yRotation=Number(e.yAxisRotation),e._EditModel.zRotation=Number(e.zAxisRotation)}},PlaceModelViewModel.prototype.updateAxisScale=function(){Cesium.defined(this._EditModel)&&(this._EditModel.model.scale=Number(this.axisScale))},PlaceModelViewModel.prototype.updateBilbordIcon=function(e){var i=this;if(Cesium.defined(e)&&Cesium.defined(i._EditModel)){(i._currentModelPath=e).includes("test.dataearth.airlook.com")&&(i._currentModelPath=e.replace("test.dataearth.airlook.com",location.host)),i._EditModel.model.uri=i._currentModelPath;var t=function(){if(Cesium.defined(i._EditModel)){var e=i._EditModel.entityCollection.owner._visualizers[3]._modelHash;Cesium.defined(e[i._EditModel.id].modelPrimitive._boundingSphere)&&(i._viewer.clock.onTick.removeEventListener(t),i._primitive=e[i._EditModel.id].modelPrimitive,removeAddBox(i),addMoveBigBox(i))}};i._viewer.clock.onTick.addEventListener(t)}},PlaceModelViewModel.prototype.hidden=function(){Cesium.defined(this._eventHandler)&&0<this._layerIndex&&(layui.layer.close(this._layerIndex),this._eventHandler.destroy(),this._eventHandler=void 0,this.cleanUp(),this.End(),modelListLayer&&(layui.layer.close(modelListLayer),modelListLayer=void 0))},PlaceModelViewModel.prototype.Edit=function(e){var a=e,o=this;Cesium.defined(a)&&layui.use("layer",function(){var e=layui.layer;o._layerIndex=e.open({type:1,skin:"dataEarth-viewer-modelLayer",area:"262px",shade:0,anim:0,title:" ",resize:!1,offset:["80px","360px"],content:$(o._element),success:function(){o._viewer.flyTo(a),o._viewer.layersManager&&(o._viewer.layersManager.viewModel._layersManagerOverLay="block"),o._ellipsoid=Cesium.Ellipsoid.WGS84,o.initialiseHandlers(),o._EditModel=a,o._drawing=!0,o._canDrawing=!0,o._canMove=!1,o._EditType=EditModelType.EMT_HANDLE_MOVE_XY;var e=Cesium.Cartographic.fromCartesian(o._EditModel.position.getValue());if(o.placeLongitude=Cesium.Math.toDegrees(e.longitude).toFixed(6),o.placeLatitude=Cesium.Math.toDegrees(e.latitude).toFixed(6),o.height=e.height.toFixed(6),o.axisScale=o._EditModel.model.scale.getValue(),o.modelName=o._EditModel.name,o.heightReference=o._EditModel.model.heightReference,o._currentModelPath=a.model.uri.getValue(),Cesium.defined(o._EditModel.xAxisRotation))o.xAxisRotation=o._EditModel.xRotation.toFixed(6),o.yAxisRotation=o._EditModel.yRotation.toFixed(6),o.zAxisRotation=o._EditModel.zRotation.toFixed(6);else if(Cesium.defined(o._EditModel.orientation)){var i=gethpr(o);o.xAxisRotation=Cesium.Math.toDegrees(i.roll).toFixed(6),o.yAxisRotation=Cesium.Math.toDegrees(i.pitch).toFixed(6),o.zAxisRotation=Cesium.Math.toDegrees(i.heading).toFixed(6)}else o.xAxisRotation=0,o.yAxisRotation=0,o.zAxisRotation=0;var t=o._EditModel.entityCollection.owner._visualizers[3]._modelHash;Cesium.defined(t[o._EditModel.id].modelPrimitive._boundingSphere)&&(o._primitive=t[o._EditModel.id].modelPrimitive,removeAddBox(o),addMoveBigBox(o))},cancel:function(e,i){o._viewer.layersManager&&(o._viewer.layersManager.viewModel._layersManagerOverLay="none"),o.hidden()}})})},PlaceModelViewModel.prototype.Show=function(){var o=this;layui.use("layer",function(){var t=layui.layer;o._layerIndex=t.open({type:1,skin:"dataEarth-viewer-modelLayer",area:"262px",shade:0,anim:0,title:" ",resize:!1,offset:["80px","360px"],content:$(o._element),success:function(){o._viewer.layersManager&&(o._viewer.layersManager.viewModel._layersManagerOverLay="block"),o.initialiseHandlers(),o.Start(),getPublicModel(1,4,function(e){o.modelArray=e.dataList,o._currentModelPath=e.dataList[0].dataView;var i=document.createElement("span");document.querySelector(".elementModel").appendChild(i),i.addEventListener("click",function(){modelListLayer||(modelListLayer=t.open({type:1,skin:"dataEarth-viewer-modelList",area:"330px",shade:0,anim:0,title:" ",resize:!1,move:!1,offset:["224px","630px"],content:"",success:function(){var e=$(".dataEarth-viewer-modelList .layui-layer-title"),t=$(".dataEarth-viewer-modelList .layui-layer-content");function i(e){var i=e.dataList;i.splice(0,4),0<i.length?(i.forEach(function(e){t.append($('<a class="publicModel" data-model-url="'.concat(e.dataView,'"><img src="').concat(e.dataCoverUrl,'"/></a>')))}),$(".publicModel").on("click",function(){o._currentModelPath=$(this).attr("data-model-url"),o._drawing=!0,o.updateBilbordIcon(o._currentModelPath),$(this).siblings().removeClass("current"),$(this).addClass("current")})):($($(".dataEarth-viewer-modelList .layui-layer-title a")[1]).trigger("click"),$($(".dataEarth-viewer-modelList .layui-layer-title a")[0]).hide())}function a(e){t.append($('\n                                <div class="customModel-title">\n                                    <span>名称</span>\n                                    <span>描述</span>\n                                </div>\n                                ')),e.dataServiceList&&0<e.dataServiceList.length?(e.dataServiceList.forEach(function(e){t.append($('\n                                        <a class="customModel-list" data-model-url="'.concat(e.dataView,'">\n                                            <span>').concat(e.dataServiceName,"</span>\n                                            <span>").concat(e.description,"</span>\n                                        </a>\n                                        ")))}),$(".customModel-list").on("click",function(){o._currentModelPath=$(this).attr("data-model-url"),console.log(o._currentModelPath),$(this).siblings().removeClass("current"),$(this).addClass("current")})):t.append($("<div>暂无数据</div>"))}e.append($('\n                                <a class="active">系统模型</a>\n                                <a>用户自定义模型</a>\n                                ')),$(".dataEarth-viewer-modelList .layui-layer-title a").on("click",function(){$(this).siblings().removeClass("active"),$(this).addClass("active"),$(".dataEarth-viewer-modelList .layui-layer-content").empty(),"系统模型"===$(this).text()?getPublicModel(1,34,i):getCustomModel(1,30,a)}),getPublicModel(1,34,i)},cancel:function(){modelListLayer=void 0}}))})})},cancel:function(e,i){o._viewer.layersManager&&(o._viewer.layersManager.viewModel._layersManagerOverLay="none"),o.hidden()}})})};